<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@600&display=swap" rel="stylesheet">
    <title>Book review on Musicophilia</title>
    <style>
        /* All CSS styles remain exactly the same as in the original code */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #ffffff; line-height: 1.4; font-size: 16px; }
        .header { background-color: #ffffff; padding: 12px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 100; height: 60px; }
        .main-container { margin-top: 60px; display: flex; flex-direction: column; background: #ffffff; height: calc(100vh - 60px); }
        .panels-container { display: flex; flex: 1; overflow: hidden; }
        .passage-panel { flex: 1; padding: 20px 20px 100px; overflow-y: auto; min-width: 200px; }
        .text-center { text-align: center; }
        .reading-passage h4 { font-family: 'Merriweather', serif; font-size: 20px; font-weight: 600; color: #2c3e50; line-height: 1.4; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #4a90e2; padding-bottom: 5px; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); }
        .reading-passage p { margin-bottom: 1.2em; text-align: justify; }
        .questions-panel { flex: 1; padding: 20px 20px 100px; overflow-y: auto; min-width: 200px; border-left: 1px solid #e0e0e0; }
        .resizer { width: 10px; cursor: col-resize; background-color: #f0f0f0; flex-shrink: 0; flex-grow: 0; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="30" viewBox="0 0 10 30"><path d="M4 11h2v2H4zM4 15h2v2H4zM4 19h2v2H4z" fill="%23888"/></svg>'); background-repeat: no-repeat; background-position: center; }
        .question-number { background: white; border: 1px solid #4a90e2; padding: 4px 8px; border-radius: 3px; font-weight: bold; font-size: 14px; color: #4a90e2; min-width: 30px; text-align: center; }
        .question-prompt { margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 5px; border-left: 4px solid #4a90e2; }
        
        .answer-input { border: 1px solid #888; border-radius: 4px; background-color: #fff; padding: 2px 5px; font-size: 16px; text-align: center; margin: 0 4px; transition: border-color 0.3s, box-shadow 0.3s; height: 30px; width: 60px; display: inline-block; cursor: pointer; }
        .answer-input.active-input { border-color: #4a90e2; box-shadow: 0 0 3px 1px rgba(74, 144, 226, 0.5); }
        .answer-input.correct { border-color: #28a745; background-color: #e9f7ef; color: #155724; font-weight: bold; }
        .answer-input.incorrect { border-color: #dc3545; background-color: #f8d7da; color: #721c24; }
        
        .part-header { background-color: #f1f2ec; padding: 15px 20px; border: 1px solid #e0e0e0; text-align: left; margin: 10px 20px; border-radius: 5px; }
        .example-box { border: 1px solid #ddd; background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .timer-container { display: flex; align-items: center; font-weight: 500; }
        .timer-controls { display: flex; gap: 8px; margin-left: 15px; }
        .timer-controls button { background: #f0f0f0; border: 1px solid #ccc; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-row { position: fixed; bottom: 0; left: 0; right: 0; background: #ffffff; padding: 0; display: flex; align-items: center; height: 80px; z-index: 100; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .footer__questionWrapper___1tZ46 { display: flex; align-items: center; margin-right: 20px; padding-left: 20px; }
        .footer__questionNo___3WNct { background: none; border: none; padding: 10px 15px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .footer__subquestionWrapper___9GgoP { display: flex; gap: 5px; margin-left: 10px; flex-wrap: wrap; }
        .subQuestion { width: 36px; height: 36px; border: 1px solid #ccc; background: white; color: #333; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
        .subQuestion:hover { background-color: #f0f0f0; }
        .subQuestion.active { background-color: #4a90e2; color: white; border-color: #4a90e2; }
        .subQuestion.correct { background-color: #28a745; color: white; border-color: #28a745; }
        .subQuestion.incorrect { background-color: #dc3545; color: white; border-color: #dc3545; }
        .subQuestion.answered { background-color: #e9ecef; border-color: #bbb; }
        .footer__deliverButton___3FM07 { margin-left: auto; margin-right: 20px; background-color: #4a90e2; color: #fff; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .footer__deliverButton___3FM07:hover { background-color: #357abd; }
        .hidden { display: none !important; }
        
        /* Specific styles for Sentence Completion */
        .option-list { list-style: none; padding-left: 10px; }
        .option-list li { margin-bottom: 10px; font-size: 15px; }
        .option-list strong { color: #4a90e2; margin-right: 8px; display: inline-block; width: 25px; }
        
        .question-item { margin-bottom: 20px; display: flex; align-items: baseline; justify-content: space-between; gap: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px;}
        .question-text { flex: 1; font-weight: 500;}
        .explanation-btn { font-size: 12px; background-color: #e9ecef; color: #333; padding: 2px 6px; border-radius: 4px; cursor: pointer; margin-left: 10px; border: 1px solid #ccc; display: none; }
        .explanation-btn:hover { background-color: #dbe0e5; }
        .show-explanation .explanation-btn { display: inline-block; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 600px; text-align: center; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #888; }
        .results-summary { font-size: 20px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .correct-answer-display { color: #28a745; font-weight: bold; margin-left: 5px; font-size: 14px; background: #d4edda; padding: 0 4px; border-radius: 3px; }
        .result-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .result-row:hover { background-color: #f9f9f9; }

        /* Explanation content styles */
        .explanation-content { text-align: left; line-height: 1.6; font-size: 15px; color: #333; }
        .explanation-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: #4a90e2; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .keyword-highlight { font-weight: bold; color: #d63384; }
        
        /* Highlighting */
        .highlight { background-color: #ffff00; }
        .context-menu { position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none; min-width: 140px; }
        .context-menu-item { padding: 12px 16px; cursor: pointer; font-size: 16px; border-bottom: 1px solid #f0f0f0; }
        .context-menu-item:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="header">
        <div class="timer-container">
            <span class="timer-display">40:00</span>
            <div class="timer-controls">
                <button id="timer-toggle-btn" title="Pause/Resume Timer">||</button>
                <button id="timer-reset-btn" title="Reset Timer">↺</button>
            </div>
        </div>
        <div style="font-weight: bold; color: #4a90e2;">Đình Phước Edu</div>
    </div>

    <div class="main-container">
        <div id="passage-header-container">
            <div id="part-header-1" class="part-header">
                <p><strong>Practice test</strong></p>
                <p>Read the text and answer questions 37-40.</p>
            </div>
        </div>
        
        <div class="panels-container">
            <div class="passage-panel" id="passage-panel">
                <div id="passage-text-1" class="reading-passage">
                    <h4 class="text-center">Book review on Musicophilia</h4>
                    <p style="text-align: center; font-style: italic; margin-bottom: 20px; font-size: 14px;">Norman M. Weinberger reviews the latest work of Oliver Sacks.</p>
                    
                    <p><strong>A.</strong> Music and the brain are both endlessly fascinating subjects, and as a neuroscientist specialising in auditory learning and memory, I find them especially intriguing. So I had high expectations of Musicophilia, the latest offering from neurologist and prolific author Oliver Sacks. And I confess to feeling a little guilty reporting that my reactions to the book are mixed.</p>
                    <p><strong>B.</strong> Sacks himself is the best part of Musicophilia. He richly documents his own life in the book and reveals highly personal experiences. The photograph of him on the cover of the book- which shows him wearing headphones, eyes closed, clearly enchanted as he listens to Alfred Brendel perform Beethoven’s Pathetique Sonata-makes a positive impression that is home out by the contents of the book. Sacks’s voice throughout is steady and erudite but never pontifical. He is neither self- conscious nor self-promoting.</p>
                    <p><strong>C.</strong> The preface gives a good idea of what the book will deliver. In it Sacks explains that he wants to convey the insights gleaned from the “enormous and rapidly growing body of work on the neural underpinnings of musical perception and imagery, and the complex and often bizarre disorders to which these are prone.” He also stresses the importance of “the simple art of observation” and “the richness of the human context.” He wants to combine “observation and description with the latest in technology,” he says, and to imaginatively enter into the experience of his patients and subjects. The reader can see that Sacks, who has been practicing neurology for 40 years, is tom between the ‘ old-fashioned path o observation and the new fangled, high-tech approach: He knows that he needs to take heed of the latter, but his heart lies with the former.</p>
                    <p><strong>D.</strong> The book consists mainly of detailed descriptions of cases, most of them involving patients whom Sacks has seen in his practice. Brief discussions of contemporary neuroscientific reports are sprinkled liberally throughout the text. Part, “Haunted by Music,” begins with the strange case of Tony Cicoria, a nonmusical, middle-aged surgeon who was consumed by a love of music after being hit by lightning. He suddenly began to crave listening to piano music, which he had never cared for in the past. He started to play the piano and then to compose music, which arose spontaneously in his mind in a “torrent” of notes. How could this happen? Was the cause psychological? (He had had a near-death experience when the lightning struck him.) Or was it the direct result of a change in the auditory regions of his cerebral cortex? Electroencephalography (EEG) showed his brain waves to be normal in the mid-1990s, just after his, trauma and subsequent “conversion” to music. There are now more sensitive tests, but Cicoria, has declined to undergo them; he does not want to delve into the causes of his musicality. What a shame!</p>
                    <p><strong>E.</strong> Part II, “A Range of Musicality,” covers a wider variety of topics, but unfortunately, some of the chapters offer little or nothing that is new. For example, chapter 13, which is five pages long, merely notes that the blind often have better hearing than the sighted. The most interesting chapters are those that present the strangest cases. Chapter 8 is about “amusia,” an inability to hear sounds as music, and “dysharmonia,” a highly specific impairment of the ability to hear harmony, with the ability to understand melody left intact. Such specific “dissociations” are found throughout the cases Sacks recounts.</p>
                    <p><strong>F.</strong> To Sacks’s credit, part III, “Memory, Movement and Music,” brings us into the underappreciated realm of music therapy. Chapter 16 explains how “melodic intonation therapy” is being used to help expressive aphasic patients (those unable to express their thoughts verbally following a stroke or other cerebral incident) once again become capable of fluent speech. In chapter 20, Sacks demonstrates the near-miraculous power of music to animate Parkinson’s patients and other people with severe movement disorders, even those who are frozen into odd postures. Scientists cannot yet explain how music achieves this effect.</p>
                    <p><strong>G.</strong> To readers who are unfamiliar with neuroscience and music behavior, Musicophilia may be something of a revelation. But the book will not satisfy those seeking the causes and implications of the phenomena Sacks describes. For one thing, Sacks appears to be more at ease discussing patients than discussing experiments. And he tends to be rather uncritical in accepting scientific findings and theories.</p>
                    <p><strong>H.</strong> It’s true that the causes of music-brain oddities remain poorly understood. However, Sacks could have done more to draw out some of the implications of the careful observations that he and other neurologists have made and of the treatments that have been successful. For example, he might have noted that the many specific dissociations among components of music comprehension, such as loss of the ability to perceive harmony but not melody, indicate that there is no music center in the brain. Because many people who read the book are likely to believe in the brain localisation of all mental functions, this was a missed educational opportunity.</p>
                    <p><strong>I.</strong> Another conclusion one could draw is that there seem to be no “cures” for neurological problems involving music. A drug can alleviate a symptom in one patient and aggravate it in another, or can have both positive and negative effects in the same patient. Treatments mentioned seem to be almost exclusively antiepileptic medications, which “damp down” the excitability of the brain in general; their effectiveness varies widely.</p>
                    <p><strong>J.</strong> Finally, in many of the cases described here the patient with music-brain symptoms is reported to have “normal” EEG results. Although Sacks recognises the existence of new technologies, among them far more sensitive ways to analyze brain waves than the standard neurological EEG test, he does not call for their use. In fact, although he exhibits the greatest compassion for patients, he conveys no sense of urgency about the pursuit of new avenues in the diagnosis and treatment of music-brain disorders. This absence echoes the book’s preface, in which Sacks expresses fear that “the simple art of observation may be lost” if we rely too much on new technologies. He does call for both approaches, though, and we can only hope that the neurological community will respond.</p>
                </div>
            </div>
            
            <div class="resizer" id="resizer"></div>
            
            <div class="questions-panel" id="questions-panel">
                <div id="questions-1" class="question-set">
                    <div class="questions-container">
                        <div class="question" data-q-start="37" data-q-end="40">
                            <div class="question-prompt">
                                <p><strong>Questions 37-40</strong></p>
                                <p>Complete each sentence with the correct ending, <strong>A-F</strong>, below.</p>
                                <p>Write the correct letter, <strong>A-F</strong>, in boxes 37-40 on your answer sheet.</p>
                            </div>

                            <div class="example-box">
                                <p><strong>List of Endings</strong></p>
                                <ul class="option-list">
                                    <li><strong>A</strong> show no music-brain disorders.</li>
                                    <li><strong>B</strong> indicates that medication can have varied results.</li>
                                    <li><strong>C</strong> is key for the neurological community to unravel the mysteries.</li>
                                    <li><strong>D</strong> should not be used in Isolation.</li>
                                    <li><strong>E</strong> indicate that not everyone can receive good education.</li>
                                    <li><strong>F</strong> show a misconception that there is function centre localized in the brain.</li>
                                </ul>
                            </div>

                            <div class="question-list">
                                <div class="question-item">
                                    <div class="question-text"><strong>37.</strong> The content covered dissociations in understanding between harmony and melody.</div>
                                    <select class="answer-input" id="q37">
                                        <option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option>
                                    </select>
                                    <span class="explanation-btn" onclick="showExplanation(37)">ℹ️ Xem giải thích</span>
                                </div>
                                <div class="question-item">
                                    <div class="question-text"><strong>38.</strong> The study of treating musical disorders.</div>
                                    <select class="answer-input" id="q38">
                                        <option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option>
                                    </select>
                                    <span class="explanation-btn" onclick="showExplanation(38)">ℹ️ Xem giải thích</span>
                                </div>
                                <div class="question-item">
                                    <div class="question-text"><strong>39.</strong> The EEG scans of Sacks’s patients.</div>
                                    <select class="answer-input" id="q39">
                                        <option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option>
                                    </select>
                                    <span class="explanation-btn" onclick="showExplanation(39)">ℹ️ Xem giải thích</span>
                                </div>
                                <div class="question-item">
                                    <div class="question-text"><strong>40.</strong> Sacks believes testing based on new technologies.</div>
                                    <select class="answer-input" id="q40">
                                        <option value=""></option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option><option value="F">F</option>
                                    </select>
                                    <span class="explanation-btn" onclick="showExplanation(40)">ℹ️ Xem giải thích</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="nav-row" aria-label="Questions">
        <div class="footer__questionWrapper___1tZ46 selected" role="tablist">
            <button role="tab" class="footer__questionNo___3WNct">
                <span>
                    <span aria-hidden="true" class="section-prefix">Questions </span>
                    <span class="sectionNr" aria-hidden="true">37-40</span>
                    <span class="attemptedCount" aria-hidden="true">0 of 4</span>
                </span>
            </button>
            <div class="footer__subquestionWrapper___9GgoP">
                <button class="subQuestion scorable-item" onclick="goToQuestion(37)">37</button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(38)">38</button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(39)">39</button>
                <button class="subQuestion scorable-item" onclick="goToQuestion(40)">40</button>
            </div>
        </div>
        
        <button id="deliver-button" aria-label="Review your answers" class="footer__deliverButton___3FM07">
            <span>Check Answers</span>
        </button>
    </nav>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div id="menu-highlight" class="context-menu-item" onclick="highlightText()">Highlight</div>
        <div id="menu-clear" class="context-menu-item" onclick="clearHighlight()">Clear</div>
    </div>

    <!-- Results Modal -->
    <div id="results-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeResultsModal()">&times;</button>
            <h2>Results</h2>
            <div class="results-summary">
                <p>Score: <span id="results-score"></span> / 4</p>
            </div>
            <p style="margin-bottom: 10px; font-size: 14px; color: #666;">Click on a row to see the explanation.</p>
            <div id="results-details" style="text-align: left;"></div>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeExplanationModal()">&times;</button>
            <div id="explanation-content" class="explanation-content"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const correctAnswers = {
            '37': 'F',
            '38': 'B',
            '39': 'A',
            '40': 'D'
        };

        const explanations = {
            '37': `
                <div class="explanation-title">Question 37: The content covered dissociations in understanding between harmony and melody...</div>
                <p><strong>Keywords:</strong> dissociations, understanding, harmony, melody</p>
                <p>Paragraph H mentions: "For example, he might have noted that the many specific dissociations among components of music comprehension, such as loss of the ability to perceive harmony but not melody, indicate that there is no music center in the brain."</p>
                <p>It implies: "<span class="keyword-highlight">Because many people who read the book are likely to believe in the brain localisation of all mental functions, this was a missed educational opportunity.</span>"</p>
                <p>This shows a misconception that there is a function centre localized in the brain.</p>
                <p>So, the answer is: <strong>F (show a misconception that there is function centre localized in the brain.)</strong></p>
            `,
            '38': `
                <div class="explanation-title">Question 38: The study of treating musical disorders...</div>
                <p><strong>Keywords:</strong> treating, musical disorders</p>
                <p>Paragraph I discusses treatments: "<span class="keyword-highlight">Treatments mentioned seem to be almost exclusively antiepileptic medications... their effectiveness varies widely.</span>"</p>
                <p>This indicates that medication can have varied results.</p>
                <p>So, the answer is: <strong>B (indicates that medication can have varied results.)</strong></p>
            `,
            '39': `
                <div class="explanation-title">Question 39: The EEG scans of Sacks’s patients...</div>
                <p><strong>Keywords:</strong> EEG scans, Sacks’s patients</p>
                <p>Paragraph J states: "Finally, in many of the cases described here <span class="keyword-highlight">the patient with music-brain symptoms is reported to have “normal” EEG results.</span>"</p>
                <p>So, the answer is: <strong>A (show no music-brain disorders.)</strong></p>
            `,
            '40': `
                <div class="explanation-title">Question 40: Sacks believes testing based on new technologies...</div>
                <p><strong>Keywords:</strong> Sacks, testing, new technologies</p>
                <p>Paragraph J states: "...Sacks expresses fear that “the simple art of observation may be lost” if we rely too much on new technologies. <span class="keyword-highlight">He does call for both approaches...</span>"</p>
                <p>This means new technologies should not be used in isolation.</p>
                <p>So, the answer is: <strong>D (should not be used in Isolation.)</strong></p>
            `
        };

        const questionIds = [37, 38, 39, 40];
        let timeInSeconds = 2400; // 40 mins
        let timerInterval;
        let selectedRange = null;

        // --- ELEMENTS ---
        const timerDisplay = document.querySelector('.timer-display');
        const deliverButton = document.getElementById('deliver-button');
        const resizer = document.getElementById('resizer');
        const passagePanel = document.getElementById('passage-panel');
        const contextMenu = document.getElementById('contextMenu');

        // --- INITIALIZATION ---
        function initialize() {
            startTimer();
            
            // Listeners
            deliverButton.addEventListener('click', checkAnswers);
            document.body.addEventListener('change', updateIndicators);
            
            // Security
            document.addEventListener("keydown", function (e) {
                if (
                    e.key === "F12" ||
                    (e.ctrlKey && e.shiftKey && e.key === "I") ||
                    (e.ctrlKey && e.shiftKey && e.key === "J") ||
                    (e.ctrlKey && e.shiftKey && e.key === "C") ||
                    (e.ctrlKey && e.key === "u") ||
                    (e.ctrlKey && e.key === "p") ||
                    (e.ctrlKey && e.key === "s")
                ) {
                    e.preventDefault();
                    return false;
                }
            });

            // Resizer logic
            resizer.addEventListener('mousedown', initResize, false);
            
            // Context menu logic
            initializeContextMenu();
        }

        // --- CORE LOGIC ---
        function checkAnswers() {
            clearInterval(timerInterval);
            let score = 0;
            const resultsContainer = document.getElementById('results-details');
            resultsContainer.innerHTML = '';
            
            // Disable inputs
            document.querySelectorAll('.answer-input').forEach(input => input.disabled = true);
            deliverButton.disabled = true;
            deliverButton.textContent = "Checked";
            
            // Enable explanation buttons
            document.querySelector('.questions-panel').classList.add('show-explanation');

            questionIds.forEach(id => {
                const input = document.getElementById(`q${id}`);
                const userAnswer = input.value;
                const correctAnswer = correctAnswers[id];
                const isCorrect = userAnswer === correctAnswer;
                
                if (isCorrect) {
                    score++;
                    input.classList.add('correct');
                    // Mark nav button
                    document.querySelector(`.subQuestion[onclick="goToQuestion(${id})"]`).classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                    // Show correct answer
                    const span = document.createElement('span');
                    span.className = 'correct-answer-display';
                    span.textContent = `✓ ${correctAnswer}`;
                    input.parentNode.insertBefore(span, input.nextSibling);
                    // Mark nav button
                    document.querySelector(`.subQuestion[onclick="goToQuestion(${id})"]`).classList.add('incorrect');
                }

                // Add to results modal list
                const row = document.createElement('div');
                row.className = 'result-row';
                row.innerHTML = `
                    <span style="font-weight:bold;">Q${id}</span>
                    <span>Your Answer: <span style="color:${isCorrect ? 'green' : 'red'}">${userAnswer || 'None'}</span></span>
                    <span style="color:green; font-weight:bold;">Correct: ${correctAnswer}</span>
                `;
                row.onclick = () => showExplanation(id);
                resultsContainer.appendChild(row);
            });

            // Show Modal
            document.getElementById('results-score').textContent = score;
            document.getElementById('results-modal').classList.remove('hidden');
        }

        function updateIndicators() {
            let answered = 0;
            questionIds.forEach(id => {
                const val = document.getElementById(`q${id}`).value;
                const btn = document.querySelector(`.subQuestion[onclick="goToQuestion(${id})"]`);
                if(val) {
                    answered++;
                    btn.classList.add('answered');
                } else {
                    btn.classList.remove('answered');
                }
            });
            document.querySelector('.attemptedCount').textContent = `${answered} of ${questionIds.length}`;
        }

        window.goToQuestion = (id) => {
            const el = document.getElementById(`q${id}`);
            if(el) {
                el.scrollIntoView({behavior: 'smooth', block: 'center'});
                document.querySelectorAll('.active-input').forEach(e => e.classList.remove('active-input'));
                el.classList.add('active-input');
                el.focus();
                
                // Update nav active state
                document.querySelectorAll('.subQuestion').forEach(b => b.classList.remove('active'));
                document.querySelector(`.subQuestion[onclick="goToQuestion(${id})"]`).classList.add('active');
            }
        };

        window.closeResultsModal = () => {
            document.getElementById('results-modal').classList.add('hidden');
        }

        window.showExplanation = (id) => {
            const content = explanations[id];
            if (content) {
                document.getElementById('explanation-content').innerHTML = content;
                document.getElementById('explanation-modal').classList.remove('hidden');
            }
        };

        window.closeExplanationModal = () => {
            document.getElementById('explanation-modal').classList.add('hidden');
        }

        // --- UTILS (Timer, Resizer, Highlight) ---
        function startTimer() {
            timerInterval = setInterval(() => {
                timeInSeconds--;
                const m = Math.floor(timeInSeconds / 60).toString().padStart(2,'0');
                const s = (timeInSeconds % 60).toString().padStart(2,'0');
                timerDisplay.textContent = `${m}:${s}`;
                if(timeInSeconds <= 0) clearInterval(timerInterval);
            }, 1000);
        }

        function initResize(e) {
            e.preventDefault();
            const startX = e.clientX;
            const startWidth = passagePanel.offsetWidth;
            const doDrag = (e) => {
                passagePanel.style.flex = `0 0 ${startWidth + e.clientX - startX}px`;
            };
            const stopDrag = () => {
                window.removeEventListener('mousemove', doDrag);
                window.removeEventListener('mouseup', stopDrag);
            };
            window.addEventListener('mousemove', doDrag);
            window.addEventListener('mouseup', stopDrag);
        }

        function initializeContextMenu() {
            document.addEventListener('selectionchange', () => {
                const sel = window.getSelection();
                if(sel.toString().length > 0) selectedRange = sel.getRangeAt(0);
            });
            
            document.addEventListener('contextmenu', (e) => {
                if(e.target.closest('.passage-panel') || e.target.closest('.questions-panel')) {
                    e.preventDefault();
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                }
            });

            document.addEventListener('click', (e) => {
                if(!contextMenu.contains(e.target)) contextMenu.style.display = 'none';
            });
        }

        window.highlightText = () => {
            if(selectedRange) {
                const span = document.createElement('span');
                span.className = 'highlight';
                span.appendChild(selectedRange.extractContents());
                selectedRange.insertNode(span);
            }
            contextMenu.style.display = 'none';
        };

        window.clearHighlight = () => {
             const highlights = document.querySelectorAll('.highlight');
             highlights.forEach(h => {
                 const parent = h.parentNode;
                 while(h.firstChild) parent.insertBefore(h.firstChild, h);
                 parent.removeChild(h);
             });
             contextMenu.style.display = 'none';
        };

        initialize();
    });
    </script>
</body>
</html>