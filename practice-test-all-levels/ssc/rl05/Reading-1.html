<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Reading Proficiency Test</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .highlight-yellow {
            background-color: #fef08a;
            border-bottom: 2px solid #eab308;
            cursor: pointer;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            width: 180px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #374151;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .explanation-box {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Cải thiện độ tương phản cho đáp án được chọn --- */
        .option-radio:checked + label {
            border-color: #1d4ed8; /* Blue-700: Đậm hơn */
            background-color: #dbeafe; /* Blue-100: Đậm hơn */
            color: #1e40af; /* Blue-800: Đậm hơn */
            font-weight: 600;
            box-shadow: 0 0 0 1px #1d4ed8; /* Thêm viền bóng để rõ hơn */
        }

        /* Review Mode Styles */
        .review-mode .correct-option {
            background-color: #dcfce7 !important; /* Green-100 */
            border-color: #15803d !important; /* Green-700 */
            color: #14532d !important;
            font-weight: 600;
        }
        
        .review-mode .wrong-option {
            background-color: #fee2e2 !important; /* Red-100 */
            border-color: #b91c1c !important; /* Red-700 */
            color: #7f1d1d !important;
            font-weight: 600;
        }

        .no-select { user-select: none; }
        
        .question-block {
            transition: all 0.2s;
        }
        .question-block:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-book-open"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">Reading Proficiency Test</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-sm text-gray-500 hidden md:block">
                <i class="fa-regular fa-clock mr-1"></i> Thời gian: Không giới hạn
            </div>
            <div id="score-display" class="hidden bg-green-100 text-green-800 px-4 py-1 rounded-full font-bold border border-green-200 shadow-sm">
                Điểm: <span id="score-value">0/0</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden relative" id="main-container">
        
        <!-- Left Panel: Reading Text -->
        <div class="w-1/2 bg-white border-r border-gray-200 overflow-y-auto relative custom-scrollbar" id="reading-panel">
            <div class="p-8 max-w-3xl mx-auto">
                <div class="mb-4">
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded uppercase tracking-wide" id="reading-tag">Topic</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-6 leading-tight" id="reading-title">Title</h2>
                
                <!-- Reading Content -->
                <div class="prose prose-blue text-gray-700 leading-loose text-lg text-justify" id="reading-content">
                    <!-- Content injected via JS -->
                </div>

                <!-- Vocabulary Table -->
                <div class="mt-12 pt-8 border-t-2 border-dashed border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-spell-check text-yellow-500 mr-2"></i> Từ vựng quan trọng (B2+)
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Từ / Cụm từ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nghĩa / Ngữ cảnh</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="vocab-body">
                                <!-- Vocab injected via JS -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm text-gray-400 mt-2 italic">* Mẹo: Chuột phải vào văn bản để tô màu (Highlight).</p>
                </div>
                <div class="h-20"></div> <!-- Spacer -->
            </div>
        </div>

        <!-- Right Panel: Questions -->
        <div class="w-1/2 bg-gray-50 overflow-y-auto custom-scrollbar" id="questions-panel">
            <div class="p-8 max-w-3xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Câu hỏi</h2>
                    <span class="text-sm text-gray-500 bg-white px-3 py-1 rounded border border-gray-200 shadow-sm" id="question-count"></span>
                </div>

                <!-- Submission Notification Hint (Hidden by default) -->
                <div id="review-hint" class="hidden bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg mb-6 flex items-start">
                    <i class="fa-solid fa-circle-info mt-1 mr-3 text-blue-500"></i>
                    <div>
                        <span class="font-bold">Đã nộp bài!</span><br>
                        Nhấn vào từng câu hỏi bên dưới để xem đáp án đúng và giải thích chi tiết.
                    </div>
                </div>

                <div id="questions-container" class="space-y-6">
                    <!-- Questions injected via JS -->
                </div>
                
                <div class="h-20"></div> <!-- Spacer -->
            </div>
        </div>

    </div>

    <!-- Bottom Navigation Bar -->
    <footer class="bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 shrink-0">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            
            <!-- Pagination -->
            <div class="flex gap-2" id="pagination-controls">
                <!-- Injected via JS -->
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3">
                <button id="btn-submit" onclick="submitTest()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Nộp Bài
                </button>
                <button id="btn-reset" onclick="resetTest()" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-rotate-right"></i> Làm Lại
                </button>
            </div>
        </div>
    </footer>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="btn-highlight">
            <i class="fa-solid fa-highlighter text-yellow-500"></i> Tô sáng (Highlight)
        </div>
        <div class="context-menu-item" id="btn-remove-highlight">
            <i class="fa-solid fa-eraser text-red-500"></i> Xóa tô sáng
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity opacity-0 pointer-events-none">
        Thông báo
    </div>

    <script>
        // --- Dữ liệu bài đọc và câu hỏi ---
        const testData = [
            {
                id: 1,
                title: "Practice Exercise 1: All About Rice",
                tag: "Nông nghiệp & Lịch sử",
                content: `
                    <p class="mb-4">The first rice may have been grown in East and South Asia as long as 15,000 years ago, when people began to settle in river deltas and domesticated wild rice. Today it is grown practically everywhere, except Antarctica! Rice is grown on flooded land and on dry land, in tropical rain forests of Africa and in arid deserts of the Middle East, on coastal plains and on the Himalayan mountains.</p>
                    <p class="mb-4">In the year 2003, the world produced about 589 million tonnes of paddy rice. Most of that (about 534 million tonnes) was grown in Asia. In 2002, it is estimated that rice fields covered almost 1.5 million square km of land. Again, most of those fields are in Asia – around 1.3 million square km.</p>
                `,
                vocab: [
                    { word: "Domesticate (v)", meaning: "Thuần hóa (động thực vật) để nuôi trồng" },
                    { word: "River delta (n)", meaning: "Đồng bằng sông (nơi sông đổ ra biển)" },
                    { word: "Arid (adj)", meaning: "Khô cằn, thiếu nước (khí hậu)" },
                    { word: "Paddy rice (n)", meaning: "Lúa thóc (chưa xay xát)" }
                ],
                questions: [
                    {
                        id: "ex1_q1",
                        text: "Where is rice grown?",
                        options: [
                            { id: "A", text: "Everywhere" },
                            { id: "B", text: "Almost everywhere" },
                            { id: "C", text: "Mainly on flood lands and coastal plains" }
                        ],
                        correct: "B",
                        explanation: "<strong>Đáp án: B. Almost everywhere</strong><br><br><strong>Tại sao đúng?</strong> Bài đọc nói rằng 'rice is grown everywhere except Antarctica' (gạo được trồng khắp nơi trừ Nam Cực). Trừ đi một nơi nghĩa là 'hầu như khắp mọi nơi' (almost everywhere).<br><br><strong>Tại sao sai?</strong><br>- A sai vì có ngoại lệ Nam Cực.<br>- C sai vì chỉ đề cập một phần (flood lands/coastal plains) trong khi bài đọc liệt kê nhiều nơi hơn thế (núi, sa mạc...)."
                    },
                    {
                        id: "ex1_q2",
                        text: "In 2002, rice fields covered about ................",
                        options: [
                            { id: "A", text: "1.5 million square miles of land." },
                            { id: "B", text: "1.3 million square km of land in China." },
                            { id: "C", text: "1.5 million square km of land in the world." }
                        ],
                        correct: "C",
                        explanation: "<strong>Đáp án: C. 1.5 million square km of land in the world.</strong><br><br><strong>Chi tiết:</strong> Đoạn văn viết: 'In 2002, it is estimated that rice fields covered almost 1.5 million square km of land.'<br><br><strong>Lưu ý:</strong><br>- A sai đơn vị ('miles' vs 'km').<br>- B sai địa điểm (1.3 triệu là con số của Châu Á, không phải Trung Quốc cụ thể)."
                    }
                ]
            },
            {
                id: 2,
                title: "Practice Exercise 2: Genetically Modified (GM) Food",
                tag: "Công nghệ sinh học",
                content: `
                    <p class="mb-4">Genetically modified (GM) food is produced from plants that have had their genes tweaked in the lab. Scientists “cut and paste” a gene from another organism into a plant's DNA to give it a new characteristic. This can be to increase yield or to allow the plant to exist in a more hostile environment than normal. Pro-GM scientists say this means cheaper, more plentiful food, but opponents argue we do not know the consequences of meddling with nature.</p>
                    <p class="mb-4">Farmers have modified their crops for thousands of years by crossing similar species. However, modern GM is controversial. Critics say the modified crops could “escape” and cross with wild plants, with unknown consequences. They also argue that more chemicals are used on some GM fields, which may have a negative impact on wildlife. And while no study has found GM food to be harmful to humans, opponents say it is too soon to be sure.</p>
                    <p class="mb-4">A group of biotechnology experts say it is time to loosen Europe's draconian regulations on genetically modified crops. In a report released today, they argue that genetically modified crops have been used safely for decades, so no longer need to be automatically treated as unsafe. They also say that genetically modified crops should be reclaimed from multinational companies and treated as a public good.</p>
                `,
                vocab: [
                    { word: "Tweak (v)", meaning: "Tinh chỉnh, thay đổi nhỏ" },
                    { word: "Yield (n)", meaning: "Sản lượng (nông nghiệp)" },
                    { word: "Hostile environment", meaning: "Môi trường khắc nghiệt, khó sống" },
                    { word: "Draconian (adj)", meaning: "Hà khắc, rất nghiêm ngặt (luật lệ)" },
                    { word: "Reclaim (v)", meaning: "Đòi lại, thu hồi" },
                    { word: "Public good (n)", meaning: "Lợi ích công cộng" }
                ],
                questions: [
                    {
                        id: "ex2_q1",
                        text: "The genetic makeup of GM foods has been...",
                        options: [
                            { id: "A", text: "Twisted" },
                            { id: "B", text: "Altered" },
                            { id: "C", text: "Cut" }
                        ],
                        correct: "B",
                        explanation: "<strong>Đáp án: B. Altered</strong><br><br>Trong đoạn 1: '...plants that have had their genes tweaked in the lab'.<br>Từ 'Tweaked' đồng nghĩa với 'altered' (được thay đổi/biến đổi). 'Twisted' (xoắn) và 'Cut' (cắt) là bẫy từ ngữ."
                    },
                    {
                        id: "ex2_q2",
                        text: "By genetically engineering plants, they are...",
                        options: [
                            { id: "A", text: "Likely to increase in size." },
                            { id: "B", text: "Able to produce more." },
                            { id: "C", text: "Not able to exist in difficult conditions." }
                        ],
                        correct: "B",
                        explanation: "<strong>Đáp án: B. Able to produce more</strong><br><br>Đoạn 1: 'This can be to increase yield'.<br>'Increase yield' (tăng sản lượng) đồng nghĩa với 'produce more'. Đáp án C sai vì bài nói GM giúp cây sống trong môi trường khắc nghiệt (hostile environment)."
                    },
                    {
                        id: "ex2_q3",
                        text: "One issue with GM plants is the potential to...",
                        options: [
                            { id: "A", text: "Cause undetermined consequences by damaging wildlife." },
                            { id: "B", text: "Infect wild plants with unknown results." },
                            { id: "C", text: "Cross-pollinate." }
                        ],
                        correct: "C",
                        explanation: "<strong>Đáp án: C. Cross-pollinate</strong><br><br>Đoạn 2: 'Critics say the modified crops could “escape” and cross with wild plants'.<br>Cụm từ 'cross with wild plants' (lai chéo với cây hoang dại) chính là định nghĩa của thụ phấn chéo (cross-pollinate)."
                    },
                    {
                        id: "ex2_q4",
                        text: "It is thought, by specialists in biotechnology, that policies governing GM crops should be...",
                        options: [
                            { id: "A", text: "Tightened." },
                            { id: "B", text: "Relaxed." },
                            { id: "C", text: "Reviewed." }
                        ],
                        correct: "B",
                        explanation: "<strong>Đáp án: B. Relaxed</strong><br><br>Đoạn 3: 'it is time to loosen Europe's draconian regulations'.<br>'Loosen' (nới lỏng) đồng nghĩa với 'Relaxed'. 'Tightened' (thắt chặt) là từ trái nghĩa."
                    },
                    {
                        id: "ex2_q5",
                        text: "GM foods ought to be...",
                        options: [
                            { id: "A", text: "Reclaimed for the use of multinational companies." },
                            { id: "B", text: "Used safely." },
                            { id: "C", text: "No longer privatized." }
                        ],
                        correct: "C",
                        explanation: "<strong>Đáp án: C. No longer privatized</strong><br><br>Đoạn 3: '...reclaimed from multinational companies and treated as a public good'.<br>Nếu được coi là 'public good' (lợi ích công) và 'reclaimed from companies' (thu hồi từ các cty), nghĩa là nó không nên bị tư nhân hóa ('no longer privatized')."
                    }
                ]
            },
            {
                id: 3,
                title: "Practice Exercise 3: Travel is the best form of education",
                tag: "Hồi ký & Lịch sử",
                content: `
                    <p class="mb-4">One learns a lot while serving in the United States Army. Foreign places, stressful conditions, and absence from home can foster an out-of-the-classroom education (non-traditional education) that crosses the boundary of the odd and unusual. Today, tales of strange sea creatures and haunted islands seem like a bad Sci-Fi marathon. But these were realities for one U.S. Army soldier stationed overseas at the turn of the 20th century.</p>
                    <p class="mb-4">Historians enjoy a deep appreciation for the written word. They savour the ability to see the world through the eyes of someone who never had satellite TV, the Internet or a cell phone. Where explanation was not readily at hand in the strange lands of the Philippine Islands, the environment was ripe for adventure and the unknown. Placing one's self in such situations fosters an education that cannot be duplicated in any classroom, book or blockbuster movie. A survivor of deadly and savage situations, Colonel Horace P. Hobbs recorded these well-documented experiences that lend a degree of depth to the retelling and re-imagining of Army history.</p>
                    <p class="mb-4">The odd education of Colonel Horace P. Hobbs is revealed in his voluminous personal papers held at the U.S. Army Military History Institute. A letter of August 16, 1918, soothes his wife while he is stationed in France during World War I. "You see it is the women who suffer most during a war. Now I know you and mother are worrying about me and I am living in the most luxurious comfort and perfect safety just now." He goes to great lengths to explain his lush surroundings and the comfort he is experiencing, from bathing in a nearby brook to the size of his room and the servants who provide for him, as he attempts to console a worry-sick wife.</p>
                    <p class="mb-4">Her husband was stationed in the Philippines during the insurrection from 1899 to 1901. Colonel Hobbs wrote a book from his collected journals entitled, "Kris and Krag: Adventures among the Moros of the Southern Philippine Islands”. Among his many tales, the Colonel tells about a strange native custom on one of the small islands... They explained to him that the island was the home of the 'wok-wok', a powerful ghost who must be appeased with gifts of rice...</p>
                    <p class="mb-4">Another bizarre chapter in the Colonel's education came when he was asked by some villagers to kill a sea creature which wreaked havoc among the people whenever they slaughtered an animal for food. The blood would run into the water, and out would come the creature. The Colonel waited for the apparition to appear after a slaughter, and he was not disappointed... Upon further inspection he described the animal as being some kind of mix between an alligator and a crocodile.</p>
                    <p class="mb-4">Experience in foreign places, blended with curiosity and a desire to learn, enabled Colonel to obtain a far greater grasp of the world. These traits provided him with an education that the average person today cannot obtain from watching television or searching the web.</p>
                `,
                vocab: [
                    { word: "Foster (v)", meaning: "Nuôi dưỡng, thúc đẩy" },
                    { word: "Savour (v)", meaning: "Thưởng thức trọn vẹn" },
                    { word: "Duplicated (v)", meaning: "Sao chép, lặp lại" },
                    { word: "Voluminous (adj)", meaning: "Đồ sộ (tài liệu)" },
                    { word: "Insurrection (n)", meaning: "Cuộc nổi dậy" },
                    { word: "Appease (v)", meaning: "Xoa dịu, cúng tế" },
                    { word: "Wreak havoc (idm)", meaning: "Gây tàn phá hỗn loạn" }
                ],
                questions: [
                    {
                        id: "ex4_q1",
                        text: "What offers a non-traditional form of education?",
                        options: [
                            { id: "A", text: "Being away from home" },
                            { id: "B", text: "Being in foreign countries" },
                            { id: "C", text: "Situations that cause stress" },
                            { id: "D", text: "All of the above" }
                        ],
                        correct: "D",
                        explanation: "<strong>Đáp án: D. All of the above</strong><br><br>Đoạn 1 liệt kê cả 3 yếu tố: 'Foreign places, stressful conditions, and absence from home can foster an out-of-the-classroom education'."
                    },
                    {
                        id: "ex4_q2",
                        text: "Historians enjoy the chance to see...",
                        options: [
                            { id: "A", text: "Satellite TV." },
                            { id: "B", text: "The world through other's eyes." },
                            { id: "C", text: "The world." },
                            { id: "D", text: "Popular documented experiences." }
                        ],
                        correct: "B",
                        explanation: "<strong>Đáp án: B. The world through other's eyes.</strong><br><br>Đoạn 2: 'They savour the ability to see the world through the eyes of someone who never had satellite TV...'."
                    },
                    {
                        id: "ex4_q3",
                        text: "While in France, the Colonel...",
                        options: [
                            { id: "A", text: "Looked after his sick wife." },
                            { id: "B", text: "Lived with his wife." },
                            { id: "C", text: "Wrote letters to the U.S. Army Military History Institute." },
                            { id: "D", text: "Comforted his wife with his letters." }
                        ],
                        correct: "D",
                        explanation: "<strong>Đáp án: D. Comforted his wife with his letters.</strong><br><br>Đoạn 3: 'A letter... soothes his wife... as he attempts to console a worry-sick wife.' (Soothe/Console = Comfort = An ủi)."
                    },
                    {
                        id: "ex4_q4",
                        text: "A sea creature would appear...",
                        options: [
                            { id: "A", text: "Whenever the Colonel was in the village." },
                            { id: "B", text: "And make the Colonel disappointed." },
                            { id: "C", text: "When blood from a dead animal ran into the water." },
                            { id: "D", text: "And slaughter an animal." }
                        ],
                        correct: "C",
                        explanation: "<strong>Đáp án: C. When blood from a dead animal ran into the water.</strong><br><br>Đoạn 5: 'The blood would run into the water, and out would come the creature.'"
                    },
                    {
                        id: "ex4_q5",
                        text: "What traits helped the Colonel to get a good education?",
                        options: [
                            { id: "A", text: "A desire to travel to foreign places" },
                            { id: "B", text: "Curiosity and a good grasp of the world" },
                            { id: "C", text: "Watching TV and using the Internet" },
                            { id: "D", text: "Curiosity and a desire to learn" }
                        ],
                        correct: "D",
                        explanation: "<strong>Đáp án: D. Curiosity and a desire to learn</strong><br><br>Đoạn cuối: 'Experience in foreign places, blended with curiosity and a desire to learn, enabled Colonel to obtain a far greater grasp of the world.'"
                    }
                ]
            }
        ];

        // --- State Management ---
        let currentExerciseIndex = 0;
        let userAnswers = {}; // e.g., { "ex1_q1": "A" }
        let isSubmitted = false;
        let selectedRange = null;

        // --- DOM Elements ---
        const readingTitle = document.getElementById('reading-title');
        const readingTag = document.getElementById('reading-tag');
        const readingContent = document.getElementById('reading-content');
        const vocabBody = document.getElementById('vocab-body');
        const questionsContainer = document.getElementById('questions-container');
        const paginationControls = document.getElementById('pagination-controls');
        const questionCountLabel = document.getElementById('question-count');
        const btnSubmit = document.getElementById('btn-submit');
        const btnReset = document.getElementById('btn-reset');
        const scoreDisplay = document.getElementById('score-display');
        const scoreValue = document.getElementById('score-value');
        const contextMenu = document.getElementById('context-menu');
        const notification = document.getElementById('notification');
        const reviewHint = document.getElementById('review-hint');

        // --- Initialization ---
        function init() {
            renderPagination();
            loadExercise(0);
            
            // Event Listeners
            document.addEventListener('click', hideContextMenu);
            readingContent.addEventListener('contextmenu', showContextMenu);
            document.getElementById('btn-highlight').addEventListener('click', highlightSelection);
            document.getElementById('btn-remove-highlight').addEventListener('click', removeHighlight);
        }

        // --- Core Functions ---

        function loadExercise(index) {
            currentExerciseIndex = index;
            const data = testData[index];

            // 1. Render Reading Panel
            readingTitle.innerText = data.title;
            readingTag.innerText = data.tag;
            readingContent.innerHTML = data.content; 
            
            // Render Vocab
            vocabBody.innerHTML = data.vocab.map(v => `
                <tr class="hover:bg-blue-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-700">${v.word}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${v.meaning}</td>
                </tr>
            `).join('');

            // 2. Render Questions Panel
            questionCountLabel.innerText = `${data.questions.length} Câu hỏi`;
            questionsContainer.innerHTML = data.questions.map((q, qIndex) => `
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm transition-all question-block relative" id="block-${q.id}">
                    
                    <!-- View Explanation Label (Review Mode Only) -->
                    <div class="absolute top-4 right-4 text-blue-600 text-xs font-bold hidden review-indicator">
                        <i class="fa-solid fa-eye"></i> Xem giải thích
                    </div>

                    <div class="flex items-start gap-3 mb-4">
                        <span class="bg-gray-800 text-white text-xs font-bold px-2 py-1 rounded mt-1 shrink-0">Q${qIndex + 1}</span>
                        <p class="text-gray-800 font-medium text-lg leading-snug">${q.text}</p>
                    </div>
                    
                    <div class="space-y-3 pl-2">
                        ${q.options.map(opt => `
                            <div class="relative">
                                <input type="radio" name="${q.id}" id="${q.id}_${opt.id}" value="${opt.id}" 
                                    class="option-radio hidden peer" 
                                    ${userAnswers[q.id] === opt.id ? 'checked' : ''}
                                    ${isSubmitted ? 'disabled' : ''}
                                    onchange="handleAnswer('${q.id}', '${opt.id}')">
                                <label for="${q.id}_${opt.id}" 
                                    class="flex items-center p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all peer-checked:border-blue-700 peer-checked:bg-blue-100"
                                    id="label-${q.id}-${opt.id}">
                                    <div class="w-6 h-6 rounded-full border border-gray-300 flex items-center justify-center mr-3 peer-checked:border-blue-700 peer-checked:bg-blue-700 text-white text-xs shrink-0">
                                        ${userAnswers[q.id] === opt.id ? '<i class="fa-solid fa-check"></i>' : opt.id}
                                    </div>
                                    <span class="text-gray-700 font-medium">${opt.text}</span>
                                </label>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Explanation Area (Hidden initially) -->
                    <div class="explanation-box mt-4 pt-4 border-t border-gray-100 bg-blue-50 p-5 rounded-md text-sm text-gray-800" id="explain-${q.id}">
                        <div class="font-bold text-blue-800 mb-2 flex items-center text-base"><i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i> Giải thích chi tiết:</div>
                        <div class="leading-relaxed">
                            ${q.explanation}
                        </div>
                    </div>
                </div>
            `).join('');

            // Update UI for Submitted State if applicable
            if (isSubmitted) {
                applyReviewStyles();
                reviewHint.classList.remove('hidden');
            } else {
                reviewHint.classList.add('hidden');
            }

            updatePaginationActiveState();
        }

        function handleAnswer(questionId, selectedOptionId) {
            if (isSubmitted) return;
            userAnswers[questionId] = selectedOptionId;
        }

        function renderPagination() {
            paginationControls.innerHTML = testData.map((_, index) => `
                <button onclick="loadExercise(${index})" 
                    class="w-10 h-10 rounded-lg font-medium transition-all border border-gray-200 hover:bg-gray-100 focus:outline-none pagination-btn"
                    data-index="${index}">
                    ${index + 1}
                </button>
            `).join('');
        }

        function updatePaginationActiveState() {
            document.querySelectorAll('.pagination-btn').forEach(btn => {
                const index = parseInt(btn.getAttribute('data-index'));
                if (index === currentExerciseIndex) {
                    btn.classList.add('bg-gray-800', 'text-white', 'border-gray-800');
                    btn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-gray-800', 'text-white', 'border-gray-800');
                    btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-100');
                }
            });
        }

        // --- Submission & Grading ---

        function submitTest() {
            // FIX: Allow checking submission even if empty (with warning)
            // This prevents "button not working" feeling if user clicks it immediately
            const answeredCount = Object.keys(userAnswers).length;
            let totalQuestions = 0;
            testData.forEach(e => totalQuestions += e.questions.length);

            let msg = "Bạn có chắc chắn muốn nộp bài không?";
            if (answeredCount === 0) {
                msg = "Bạn chưa làm câu nào cả. Bạn có chắc muốn nộp bài và xem đáp án ngay không?";
            } else if (answeredCount < totalQuestions) {
                msg = `Bạn mới làm ${answeredCount}/${totalQuestions} câu. Bạn có chắc muốn nộp không?`;
            }
            
            const confirmSubmit = confirm(msg);
            if (!confirmSubmit) return;

            try {
                isSubmitted = true;
                let correctCount = 0;

                // Calculate Score
                testData.forEach(exercise => {
                    exercise.questions.forEach(q => {
                        if (userAnswers[q.id] === q.correct) {
                            correctCount++;
                        }
                    });
                });

                // Update Header
                scoreValue.innerText = `${correctCount}/${totalQuestions}`;
                scoreDisplay.classList.remove('hidden');
                scoreDisplay.classList.add('flex', 'items-center');

                // Update Buttons
                btnSubmit.classList.add('hidden');
                btnReset.classList.remove('hidden');

                // Reload current view to apply styles
                loadExercise(currentExerciseIndex);
                
                // Scroll to top
                document.getElementById('questions-panel').scrollTo({ top: 0, behavior: 'smooth' });
                
                showNotification(`Đã nộp bài! Bạn đúng ${correctCount}/${totalQuestions} câu.`);
            } catch (error) {
                console.error("Submission Error:", error);
                showNotification("Có lỗi xảy ra khi nộp bài. Vui lòng thử lại.");
            }
        }

        function applyReviewStyles() {
            const currentQuestions = testData[currentExerciseIndex].questions;
            document.body.classList.add('review-mode');

            currentQuestions.forEach(q => {
                const userAnswer = userAnswers[q.id];
                const correctAnswer = q.correct;
                const explanationBox = document.getElementById(`explain-${q.id}`);
                const questionBlock = document.getElementById(`block-${q.id}`);
                const reviewIndicator = questionBlock.querySelector('.review-indicator');

                // Show "Click to view" indicator
                if (reviewIndicator) reviewIndicator.classList.remove('hidden');

                // Disable inputs
                const inputs = document.querySelectorAll(`input[name="${q.id}"]`);
                inputs.forEach(input => input.disabled = true);

                // Show Correct Answer Style
                const correctLabel = document.getElementById(`label-${q.id}-${correctAnswer}`);
                if (correctLabel) {
                    correctLabel.classList.add('correct-option');
                    // Avoid duplicate icons if function runs multiple times (though loadExercise resets HTML)
                    if (!correctLabel.innerHTML.includes('fa-check-circle')) {
                        correctLabel.innerHTML += ` <i class="fa-solid fa-check-circle ml-auto text-green-700 text-lg"></i>`;
                    }
                }

                // Show Wrong Answer Style (if user selected it)
                if (userAnswer && userAnswer !== correctAnswer) {
                    const wrongLabel = document.getElementById(`label-${q.id}-${userAnswer}`);
                    if (wrongLabel) {
                        wrongLabel.classList.add('wrong-option');
                        if (!wrongLabel.innerHTML.includes('fa-times-circle')) {
                            wrongLabel.innerHTML += ` <i class="fa-solid fa-times-circle ml-auto text-red-700 text-lg"></i>`;
                        }
                    }
                }

                // Enable toggling explanation on click
                questionBlock.style.cursor = "pointer";
                questionBlock.onclick = (e) => {
                    // Prevent triggering when clicking inside explanation itself
                    if (e.target.closest('.explanation-box')) return;
                    
                    if (explanationBox.style.display === 'block') {
                        explanationBox.style.display = 'none';
                        questionBlock.classList.remove('ring-2', 'ring-blue-400');
                    } else {
                        explanationBox.style.display = 'block';
                        questionBlock.classList.add('ring-2', 'ring-blue-400');
                    }
                };
            });
        }

        function resetTest() {
            if(confirm("Làm lại sẽ xóa hết kết quả. Bạn có chắc không?")) {
                isSubmitted = false;
                userAnswers = {};
                document.body.classList.remove('review-mode');
                scoreDisplay.classList.add('hidden');
                btnSubmit.classList.remove('hidden');
                btnReset.classList.add('hidden');
                loadExercise(0); 
            }
        }

        // --- Context Menu & Highlighting ---

        function showContextMenu(e) {
            e.preventDefault();
            const selection = window.getSelection();
            if (selection.toString().trim() === '') return;

            selectedRange = selection.getRangeAt(0);
            
            // Calculate position (keep inside viewport)
            let x = e.clientX;
            let y = e.clientY;
            
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        function highlightSelection() {
            if (!selectedRange) return;
            try {
                const span = document.createElement('span');
                span.className = 'highlight-yellow';
                span.title = 'Nhấn để xóa';
                span.onclick = function(e) {
                    e.stopPropagation();
                    const parent = this.parentNode;
                    while(this.firstChild) parent.insertBefore(this.firstChild, this);
                    parent.removeChild(this);
                };
                selectedRange.surroundContents(span);
                window.getSelection().removeAllRanges();
            } catch (e) {
                showNotification("Vui lòng chỉ chọn văn bản trong một đoạn.");
            }
            hideContextMenu();
        }

        function removeHighlight() {
            showNotification("Mẹo: Nhấn chuột trái vào vùng đã tô màu để xóa nó.");
            hideContextMenu();
        }

        function showNotification(msg) {
            notification.innerText = msg;
            notification.style.opacity = '1';
            setTimeout(() => {
                notification.style.opacity = '0';
            }, 3000);
        }

        // Start App
        init();

    </script>
</body>
</html>