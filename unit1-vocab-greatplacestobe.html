<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Great places to be</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        .chart-container {
            position: relative;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 250px;
            width: 100%;
            max-width: 250px;
        }
         .nav-button, .filter-button, .quiz-btn {
            transition: all 0.2s ease-in-out;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .filter-button:hover {
             background-color: #3b82f6;
             color: #ffffff;
        }
        .filter-button.active {
            background-color: #1d4ed8;
            color: #ffffff;
            font-weight: 600;
        }
        .audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
            color: #64748b; /* slate-500 */
        }
        .audio-btn:hover {
            color: #3b82f6; /* blue-500 */
        }
        .audio-btn:disabled .loader {
            display: inline-block;
        }
        .audio-btn:disabled .icon {
            display: none;
        }
        .loader {
            display: none;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .quiz-answer-btn {
            text-align: left;
        }
        .quiz-answer-btn.correct {
            background-color: #22c55e; /* green-500 */
            color: white;
            border-color: #16a34a; /* green-600 */
        }
        .quiz-answer-btn.wrong {
            background-color: #ef4444; /* red-500 */
            color: white;
            border-color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Unit 1: Great places to be</h1>
            <p class="text-slate-600 mt-2">Interactive flashcards and themed groups</p>
        </header>

        <main>
            <div class="flex flex-col lg:flex-row gap-8">

                <aside class="lg:w-1/3 xl:w-1/4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-semibold mb-3 text-slate-800">Categories</h2>
                        <div id="theme-filters" class="flex flex-wrap gap-2"></div>
                         <div class="mt-6">
                            <h3 class="text-lg font-semibold mb-3 text-slate-800">Category Overview</h3>
                            <div class="chart-container">
                                <canvas id="themeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </aside>

                <div class="flex-1">
                    <div class="mb-6">
                         <input type="text" id="search-bar" placeholder="üîé Search for a word..." class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-sm">
                    </div>

                    <div id="flashcard-container" class="flashcard-container h-96 w-full mb-6">
                        <div id="flashcard" class="flashcard h-full w-full cursor-pointer rounded-xl shadow-lg border border-slate-200">
                            <div id="card-front" class="flashcard-face bg-white rounded-xl p-6">
                            </div>
                            <div id="card-back" class="flashcard-face flashcard-back bg-blue-50 rounded-xl p-6">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center">
                        <button id="prev-btn" class="nav-button bg-white px-6 py-3 rounded-lg shadow-md font-semibold text-slate-700 border border-slate-300 hover:bg-slate-100">‚Üê Previous</button>
                        <p id="card-counter" class="text-slate-600 font-medium"></p>
                        <button id="next-btn" class="nav-button bg-white px-6 py-3 rounded-lg shadow-md font-semibold text-slate-700 border border-slate-300 hover:bg-slate-100">Next ‚Üí</button>
                    </div>
                </div>
            </div>
        </main>
        
        <section id="quiz-section" class="mt-12">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div id="quiz-start-container" class="text-center">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Vocabulary Quiz</h2>
                    <p class="text-slate-600 mb-6">Test your knowledge of the vocabulary words.</p>
                    <button id="start-quiz-btn" class="quiz-btn bg-blue-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-blue-700 shadow-md">Start Quiz</button>
                </div>
                
                <div id="quiz-container" class="hidden">
                    <div id="question-container" class="mb-6 text-center">
                        <p id="question-progress" class="text-sm font-semibold text-slate-500 mb-2"></p>
                        <p id="question-text" class="text-xl font-semibold text-slate-800"></p>
                    </div>
                    <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div class="mt-6 text-center">
                        <button id="next-quiz-btn" class="quiz-btn hidden bg-blue-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-blue-700 shadow-md">Next Question</button>
                    </div>
                </div>

                <div id="quiz-results-container" class="hidden text-center">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Quiz Complete!</h2>
                    <p id="score-text" class="text-lg text-slate-600 mb-6"></p>
                    <button id="restart-quiz-btn" class="quiz-btn bg-blue-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-blue-700 shadow-md">Restart Quiz</button>
                </div>
            </div>
        </section>

        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>IELTS level 1 - Encoded by Mr. Dinh Phuoc</p>
        </footer>

    </div>

    <script>
        // Data for Flashcards
        const vocabularyData = [
            { word: 'access', ipa: '/Àà√¶k.s…õs/', meaning: 'when you have the right or opportunity to use or see something', vietnamese: 'quy·ªÅn truy c·∫≠p', example: 'Students need a password to get access to the online library.', theme: 'Actions & Effects' },
            { word: 'conclude', ipa: '/k…ônÀàkluÀêd/', meaning: 'to decide something after studying all the information about it very carefully', vietnamese: 'k·∫øt lu·∫≠n', example: 'After reviewing the evidence, they concluded he was innocent.', theme: 'Actions & Effects' },
            { word: 'conduct research', ipa: '/k…ônÀåd åkt r…™Ààs…úÀêrt É/', meaning: 'to study a subject to find information about it', vietnamese: 'ti·∫øn h√†nh nghi√™n c·ª©u', example: 'Scientists will conduct research to find a cure for the disease.', theme: 'Actions & Effects' },
            { word: 'consume', ipa: '/k…ônÀàsuÀêm/', meaning: 'to use something such as a product, energy or fuel', vietnamese: 'ti√™u th·ª•', example: 'Modern appliances consume less electricity.', theme: 'Actions & Effects' },
            { word: 'crime rate', ipa: '/Ààkra…™m Àåre…™t/', meaning: 'the amount of crime that happens in a place or during a period of time', vietnamese: 't·ªâ l·ªá t·ªôi ph·∫°m', example: 'The city has seen a steady decrease in the crime rate.', theme: 'Society & Culture' },
            { word: 'culture', ipa: '/Ààk ål.t É…ö/', meaning: 'the habits, traditions and beliefs of a country, society or group of people', vietnamese: 'vƒÉn h√≥a', example: 'It\'s important to respect the local culture when you travel.', theme: 'Society & Culture' },
            { word: 'diverse', ipa: '/d…™Ààv…ùÀês/', meaning: 'including many different types', vietnamese: 'ƒëa d·∫°ng', example: 'The restaurant has a diverse menu with dishes from all over the world.', theme: 'Qualities & Concepts' },
            { word: 'environment', ipa: '/…™nÀàva…™.r…ôn.m…ônt/', meaning: 'the situation that you live or work in, and how it influences how you feel', vietnamese: 'm√¥i tr∆∞·ªùng', example: 'A positive work environment can increase productivity.', theme: 'Environment & Place' },
            { word: 'feature', ipa: '/ÀàfiÀê.t É…ö/', meaning: 'a quality or important part of something', vietnamese: 'ƒë·∫∑c ƒëi·ªÉm', example: 'An important feature of this car is its safety system.', theme: 'Qualities & Concepts' },
            { word: 'grow up', ipa: '/…°ro ä  åp/', meaning: 'to become older or an adult', vietnamese: 'l·ªõn l√™n, tr∆∞·ªüng th√†nh', example: 'She wants to be a doctor when she grows up.', theme: 'Personal Factors' },
            { word: 'have access to', ipa: '/h√¶v Àà√¶k.s…õs tu/', meaning: 'to have the right or opportunity to have, use or see something', vietnamese: 'c√≥ quy·ªÅn truy c·∫≠p v√†o', example: 'All members have access to the gym\'s facilities.', theme: 'Actions & Effects' },
            { word: 'ignore', ipa: '/…™…°Ààn…îÀêr/', meaning: 'to pay no attention to something or someone', vietnamese: 'ph·ªõt l·ªù, b·ªè qua', example: 'It\'s best to ignore negative comments online.', theme: 'Actions & Effects' },
            { word: 'impact', ipa: '/Àà…™m.p√¶kt/', meaning: 'the effect that a person, event or situation has on someone or something', vietnamese: 't√°c ƒë·ªông, ·∫£nh h∆∞·ªüng', example: 'The teacher\'s encouragement had a huge impact on his students.', theme: 'Actions & Effects' },
            { word: 'income', ipa: '/Àà…™n.k åm/', meaning: 'money that you earn by working, investing or producing goods', vietnamese: 'thu nh·∫≠p', example: 'His monthly income is not enough to support his family.', theme: 'Personal Factors' },
            { word: 'industrial', ipa: '/…™nÀàd ås.tri.…ôl/', meaning: 'with a lot of factories', vietnamese: 'thu·ªôc v·ªÅ c√¥ng nghi·ªáp', example: 'The city is a major industrial center.', theme: 'Environment & Place' },
            { word: 'influence', ipa: '/Àà…™n.flu.…ôns/', meaning: 'to affect or change how someone or something develops, behaves or thinks', vietnamese: '·∫£nh h∆∞·ªüng', example: 'Her older sister was a big influence on her.', theme: 'Actions & Effects' },
            { word: 'landscape', ipa: '/Ààl√¶nd.ske…™p/', meaning: 'the appearance of an area of land, especially in the countryside', vietnamese: 'phong c·∫£nh', example: 'The rural landscape was dotted with small farms.', theme: 'Environment & Place' },
            { word: 'lifestyle', ipa: '/Ààla…™f.sta…™l/', meaning: 'the way that you live', vietnamese: 'l·ªëi s·ªëng', example: 'Regular exercise is part of a healthy lifestyle.', theme: 'Personal Factors' },
            { word: 'local', ipa: '/Ààlo ä.k…ôl/', meaning: 'someone who lives in the area you are talking about', vietnamese: 'ng∆∞·ªùi ƒë·ªãa ph∆∞∆°ng', example: 'We asked a local for directions to the train station.', theme: 'Society & Culture' },
            { word: 'measurement', ipa: '/Ààme í.…ö.m…ônt/', meaning: 'a way of measuring something', vietnamese: 's·ª± ƒëo l∆∞·ªùng', example: 'Precise measurement is essential in construction.', theme: 'Qualities & Concepts' },
            { word: 'nutrition', ipa: '/nuÀêÀàtr…™ É.…ôn/', meaning: 'the food that you eat and the way that it affects your health', vietnamese: 'dinh d∆∞·ª°ng', example: 'Proper nutrition is vital for a child\'s development.', theme: 'Personal Factors' },
            { word: 'outcome', ipa: '/Ààa ät.k åm/', meaning: 'the final result of an activity or process', vietnamese: 'k·∫øt qu·∫£, h·∫≠u qu·∫£', example: 'It is too early to know the outcome of the negotiations.', theme: 'Qualities & Concepts' },
            { word: 'rank', ipa: '/r√¶≈ãk/', meaning: 'to give someone or something a position in a list which shows them in order of importance or quality', vietnamese: 'x·∫øp h·∫°ng', example: 'The hotels are ranked from best to worst.', theme: 'Actions & Effects' },
            { word: 'reaction', ipa: '/riÀà√¶k. É…ôn/', meaning: 'something you say, feel or do because of something that has happened', vietnamese: 's·ª± ph·∫£n ·ª©ng', example: 'What was his reaction to the news?', theme: 'Actions & Effects' },
            { word: 'reputation', ipa: '/Àårep.j…ôÀàte…™. É…ôn/', meaning: 'the opinion that people have about someone or something based on their behaviour or character in the past', vietnamese: 'danh ti·∫øng', example: 'The restaurant has an excellent reputation for its food.', theme: 'Society & Culture' },
            { word: 'resources', ipa: '/ÀàriÀê.s…îÀêr.s…™z/', meaning: 'things that a country, person or organisation has which they can use', vietnamese: 't√†i nguy√™n', example: 'The library is a great resource for students.', theme: 'Actions & Effects' },
            { word: 'short of', ipa: '/ É…îÀêrt …ôv/', meaning: 'If you are short of something, you do not have enough of it.', vietnamese: 'thi·∫øu', example: 'I can\'t buy it because I\'m short of money this week.', theme: 'Actions & Effects' },
            { word: 'status', ipa: '/Ààste…™.tÃ¨…ôs/', meaning: 'the position that you have in relation to other people because of your job or social position', vietnamese: 'ƒë·ªãa v·ªã, t√¨nh tr·∫°ng', example: 'Her job gives her a high social status.', theme: 'Society & Culture' },
            { word: 'surround', ipa: '/s…ôÀàra änd/', meaning: 'to be or go everywhere around something or someone', vietnamese: 'bao quanh', example: 'Tall trees surround the house, giving it privacy.', theme: 'Environment & Place' },
            { word: 'tend to be', ipa: '/tend tu bi/', meaning: 'to often be in a particular state', vietnamese: 'c√≥ xu h∆∞·ªõng l√†', example: 'I tend to be more creative in the morning.', theme: 'Personal Factors' },
            { word: 'way of life', ipa: '/we…™ …ôv la…™f/', meaning: 'the manner in which a person lives', vietnamese: 'l·ªëi s·ªëng, c√°ch s·ªëng', example: 'For many, farming is more than a job; it\'s a way of life.', theme: 'Society & Culture' }
        ];

        // Quiz Data
        const quizJSON = `{"lk":[{"dra":0,"question":"The city's unique architectural style is its most defining ______.","hint":"Think about a specific quality or characteristic of the city.","Tz":[{"text":"feature","Bo":true,"UMa":"A feature is a distinctive quality or an important part of something, which fits the context of a unique architectural style."},{"text":"outcome","Bo":false,"UMa":"An outcome refers to the result of a process, not a characteristic of a place."},{"text":"status","Bo":false,"UMa":"Status relates to social or professional position, not a physical characteristic of a city."},{"text":"landscape","Bo":false,"UMa":"Landscape refers to the overall appearance of an area, especially in the countryside, while the question focuses on a specific architectural detail."}]},{"dra":0,"question":"After weeks of study, the scientists were finally able to ______ that the new drug was effective.","hint":"What is the final step after carefully considering all the information?","Tz":[{"text":"conclude","Bo":true,"UMa":"To conclude means to arrive at a judgment or decision after careful thought, which is what the scientists did."},{"text":"influence","Bo":false,"UMa":"To influence is to have an effect on something, not to make a final decision based on evidence."},{"text":"consume","Bo":false,"UMa":"To consume means to use something up, which doesn't fit the context of reaching a scientific decision."},{"text":"rank","Bo":false,"UMa":"To rank is to give something a position on a list, not to form a final judgment about its effectiveness."}]},{"dra":0,"question":"A healthy diet and good ______ are essential for physical well-being.","hint":"This word relates to the food we eat and how it affects our bodies.","Tz":[{"text":"nutrition","Bo":true,"UMa":"Nutrition specifically refers to the process of providing or obtaining the food necessary for health and growth."},{"text":"lifestyle","Bo":false,"UMa":"Lifestyle is a broader term for how a person lives; nutrition is a specific component of a healthy lifestyle."},{"text":"reaction","Bo":false,"UMa":"A reaction is a response to something, not a general state of being related to food and health."},{"text":"measurement","Bo":false,"UMa":"Measurement is the action of measuring something, not the substance of what contributes to health."}]},{"dra":0,"question":"The new law is expected to have a significant ______ on the country's economy.","hint":"Consider the effect or influence that the new law will have.","Tz":[{"text":"impact","Bo":true,"UMa":"Impact refers to the powerful effect that something has on a situation, which is fitting for a new law's effect on an economy."},{"text":"reputation","Bo":false,"UMa":"Reputation is the general opinion people have about something, which might be affected by the law, but 'impact' describes the direct effect itself."},{"text":"resource","Bo":false,"UMa":"A resource is something that can be used, not the effect of an action."},{"text":"access","Bo":false,"UMa":"Access is the right or opportunity to use something, not the effect of a new law."}]},{"dra":0,"question":"The company needs to hire people from ______ backgrounds to bring new ideas to the team.","hint":"This word describes a group that includes many different types of people or things.","Tz":[{"text":"diverse","Bo":true,"UMa":"Diverse means showing a great deal of variety, which accurately describes the goal of hiring people from different backgrounds."},{"text":"industrial","Bo":false,"UMa":"Industrial relates to factories and industry, not the variety of people's backgrounds."},{"text":"local","Bo":false,"UMa":"Hiring only local people would be the opposite of hiring from diverse backgrounds."},{"text":"short of","Bo":false,"UMa":"Being 'short of' something means not having enough, which doesn't describe a type of background."}]},{"dra":0,"question":"Despite his fame, he tried to maintain a normal ______ for his children.","hint":"This term describes the general way in which a person or group lives.","Tz":[{"text":"way of life","Bo":true,"UMa":"This phrase refers to the typical manner in which a person lives, which is what the famous person is trying to maintain for his children."},{"text":"income","Bo":false,"UMa":"Income is the money a person earns, which is only one part of their overall way of life."},{"text":"status","Bo":false,"UMa":"Status refers to his social position (which is high due to fame), but he is trying to create a normal 'way of life' despite that status."},{"text":"crime rate","Bo":false,"UMa":"Crime rate is a statistic about a location and is unrelated to an individual's daily living habits."}]},{"dra":0,"question":"The ancient castle is ______ by a deep moat and thick stone walls.","hint":"This verb means to be all around something.","Tz":[{"text":"surrounded","Bo":true,"UMa":"To surround means to be all around something or someone, which is what the moat and walls do to the castle."},{"text":"influenced","Bo":false,"UMa":"To influence is to affect something, not to physically encircle it."},{"text":"ignored","Bo":false,"UMa":"To ignore means to pay no attention to something, which doesn't make sense in this physical context."},{"text":"consumed","Bo":false,"UMa":"To consume means to use up or eat, which is not what the moat and walls are doing."}]},{"dra":0,"question":"He has a ______ for being honest and fair in his business dealings.","hint":"This word refers to the beliefs or opinions that are generally held about someone or something.","Tz":[{"text":"reputation","Bo":true,"UMa":"A reputation is the opinion people have about someone based on their past behavior, which fits the description of being known as honest."},{"text":"reaction","Bo":false,"UMa":"A reaction is a response to a single event, not a long-term opinion about someone's character."},{"text":"culture","Bo":false,"UMa":"Culture refers to the customs and beliefs of a society, not the opinion about an individual."},{"text":"feature","Bo":false,"UMa":"A feature is a characteristic, but 'reputation' specifically refers to the social perception of that characteristic."}]},{"dra":0,"question":"The country is rich in natural ______ such as oil and timber.","hint":"Think about valuable materials that a country possesses and can use.","Tz":[{"text":"resources","Bo":true,"UMa":"Resources are assets or materials that a country has and can use for economic gain, such as oil and timber."},{"text":"outcomes","Bo":false,"UMa":"Outcomes are results of actions, not raw materials found in nature."},{"text":"environments","Bo":false,"UMa":"Environments are the surroundings or conditions, not the specific materials within them."},{"text":"measurements","Bo":false,"UMa":"Measurements are units or systems of sizing, not physical materials."}]},{"dra":0,"question":"People in this region ______ be very friendly and welcoming to tourists.","hint":"This phrase is used to describe what is often or generally the case.","Tz":[{"text":"tend to","Bo":true,"UMa":"'Tend to' is used to express a common or typical behavior or characteristic, which fits the description of the people's general friendliness."},{"text":"short of","Bo":false,"UMa":"'Short of' means to have an insufficient amount of something and is not grammatically correct in this context."},{"text":"grow up","Bo":false,"UMa":"'Grow up' means to mature into an adult and does not fit the sentence structure or meaning."},{"text":"have access to","Bo":false,"UMa":"'Have access to' means to have the ability to use something and does not describe a characteristic or tendency."}]}]}`;
        const parsedQuizData = JSON.parse(quizJSON);
        const quizQuestions = parsedQuizData.lk.map(q => ({
            question: q.question,
            answers: q.Tz.map(opt => ({ text: opt.text, correct: opt.Bo }))
        }));

        // --- Flashcard Logic ---
        let currentData = [...vocabularyData];
        let currentIndex = 0;
        let themeChart;

        const flashcard = document.getElementById('flashcard');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const cardCounter = document.getElementById('card-counter');
        const themeFiltersContainer = document.getElementById('theme-filters');
        const searchBar = document.getElementById('search-bar');
        
        // --- Quiz Logic ---
        const quizStartContainer = document.getElementById('quiz-start-container');
        const quizContainer = document.getElementById('quiz-container');
        const quizResultsContainer = document.getElementById('quiz-results-container');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const nextQuizBtn = document.getElementById('next-quiz-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const questionText = document.getElementById('question-text');
        const questionProgress = document.getElementById('question-progress');
        const answerButtonsContainer = document.getElementById('answer-buttons');
        const scoreText = document.getElementById('score-text');

        let shuffledQuestions, currentQuestionIndex, score;


        // --- Audio Generation Logic ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = (numChannels * bitsPerSample) / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.byteLength;
            const waveHeaderSize = 44;
            const buffer = new ArrayBuffer(waveHeaderSize + dataSize);
            const view = new DataView(buffer);
        
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
        
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
        
            const pcmAsInt16 = new Int16Array(pcmData);
            const wavBytes = new Int16Array(buffer, waveHeaderSize);
            wavBytes.set(pcmAsInt16);
        
            return new Blob([view], { type: 'audio/wav' });
        }
        
        async function playAudio(text, buttonEl) {
            if (buttonEl.disabled) return;
        
            buttonEl.disabled = true;
            try {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                let response;
                let attempts = 0;
                const maxAttempts = 5;
                const initialDelay = 1000;

                while(attempts < maxAttempts) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break;
                        
                        if (response.status === 429 || response.status >= 500) {
                           attempts++;
                           const delay = initialDelay * Math.pow(2, attempts);
                           await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                           throw new Error(`HTTP error! status: ${response.status}`);
                        }

                    } catch (error) {
                        attempts++;
                        if (attempts >= maxAttempts) throw error;
                        const delay = initialDelay * Math.pow(2, attempts);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
        
                if (!response.ok) {
                    throw new Error(`Failed to fetch audio after ${maxAttempts} attempts.`);
                }
        
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
        
                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("Sample rate not found in MIME type");
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => URL.revokeObjectURL(audioUrl);
                } else {
                   console.error("Audio data not found in response:", result);
                }
            } catch (error) {
                console.error('Error generating or playing audio:', error);
            } finally {
                buttonEl.disabled = false;
            }
        }

        // --- Flashcard Functions ---
        function renderCard(index) {
            if (currentData.length === 0) {
                cardFront.innerHTML = `<h2 class="text-2xl font-bold text-slate-700">No words found</h2><p class="text-slate-500 mt-2">Try a different filter or search term.</p>`;
                cardBack.innerHTML = '';
                cardCounter.textContent = '0 / 0';
                flashcard.classList.remove('is-flipped');
                return;
            }

            const item = currentData[index];
            cardFront.innerHTML = `<h2 class="text-4xl md:text-5xl font-bold text-slate-800">${item.word}</h2><p class="text-slate-500 mt-4 text-sm">Click to see definition</p>`;
            cardBack.innerHTML = `
                <div class="text-left w-full h-full flex flex-col justify-center p-2">
                    <div class="flex items-center gap-x-2 mb-2">
                        <h3 class="text-2xl font-bold text-slate-900">${item.word}</h3>
                        <button class="audio-btn" data-text="${item.word}"><span class="icon">üîä</span><span class="loader"></span></button>
                    </div>
                    <p class="text-slate-500 font-mono text-sm mb-2">${item.ipa}</p>
                    <p class="text-slate-800 text-base mb-2">${item.meaning}.</p>
                    <p class="text-blue-600 font-semibold text-lg mb-4">${item.vietnamese}</p>
                    <div class="flex items-start gap-x-2">
                        <p class="text-slate-500 italic text-sm flex-1">e.g., "${item.example}"</p>
                        <button class="audio-btn" data-text="${item.example}"><span class="icon">üîä</span><span class="loader"></span></button>
                    </div>
                    <div class="mt-4"><span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">${item.theme}</span></div>
                </div>
            `;
            
            cardBack.querySelectorAll('.audio-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    playAudio(button.dataset.text, button);
                });
            });

            cardCounter.textContent = `${index + 1} / ${currentData.length}`;
            flashcard.classList.remove('is-flipped');
        }

        function updateButtons() {
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === currentData.length - 1 || currentData.length === 0;
            prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
            nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
        }

        function setupThemeFilters() {
            const themes = ['All', ...new Set(vocabularyData.map(item => item.theme))];
            themeFiltersContainer.innerHTML = themes.map(theme => `
                <button class="filter-button text-sm font-medium px-3 py-1.5 rounded-full border border-slate-300 bg-white text-slate-700" data-theme="${theme}">${theme}</button>
            `).join('');
            
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    const selectedTheme = button.dataset.theme;
                    filterByTheme(selectedTheme);
                    document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                });
            });
            document.querySelector('.filter-button[data-theme="All"]').classList.add('active');
        }
        
        function filterByTheme(theme) {
            if (theme === 'All') {
                currentData = [...vocabularyData];
            } else {
                currentData = vocabularyData.filter(item => item.theme === theme);
            }
            currentIndex = 0;
            searchBar.value = '';
            renderCard(currentIndex);
            updateButtons();
        }

        function filterBySearch() {
            const searchTerm = searchBar.value.toLowerCase();
            const activeTheme = document.querySelector('.filter-button.active').dataset.theme;
            
            let baseData = vocabularyData;
            if (activeTheme !== 'All') {
                baseData = vocabularyData.filter(item => item.theme === activeTheme);
            }

            currentData = baseData.filter(item => item.word.toLowerCase().includes(searchTerm));
            currentIndex = 0;
            renderCard(currentIndex);
            updateButtons();
        }

        function setupChart() {
            const themeCounts = vocabularyData.reduce((acc, item) => {
                acc[item.theme] = (acc[item.theme] || 0) + 1;
                return acc;
            }, {});

            const ctx = document.getElementById('themeChart').getContext('2d');
            themeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(themeCounts),
                    datasets: [{
                        label: 'Words by Theme',
                        data: Object.values(themeCounts),
                        backgroundColor: ['#60a5fa', '#f87171', '#4ade80', '#fbbf24', '#a78bfa'],
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 15, padding: 10 }}
                    }
                }
            });
        }
        
        // --- Quiz Functions ---
        function startQuiz() {
            quizStartContainer.classList.add('hidden');
            quizResultsContainer.classList.add('hidden');
            quizContainer.classList.remove('hidden');
            shuffledQuestions = quizQuestions.sort(() => Math.random() - 0.5);
            currentQuestionIndex = 0;
            score = 0;
            setNextQuestion();
        }

        function setNextQuestion() {
            resetState();
            showQuestion(shuffledQuestions[currentQuestionIndex]);
        }

        function showQuestion(question) {
            questionProgress.innerText = `Question ${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
            questionText.innerText = question.question;
            const shuffledAnswers = [...question.answers].sort(() => Math.random() - 0.5);
            shuffledAnswers.forEach(answer => {
                const button = document.createElement('button');
                button.innerText = answer.text;
                button.classList.add('quiz-answer-btn', 'quiz-btn', 'w-full', 'p-4', 'bg-white', 'rounded-lg', 'border', 'border-slate-300', 'hover:bg-slate-100');
                if (answer.correct) {
                    button.dataset.correct = true;
                }
                button.addEventListener('click', selectAnswer);
                answerButtonsContainer.appendChild(button);
            });
        }
        
        function resetState() {
            nextQuizBtn.classList.add('hidden');
            while (answerButtonsContainer.firstChild) {
                answerButtonsContainer.removeChild(answerButtonsContainer.firstChild);
            }
        }

        function selectAnswer(e) {
            const selectedBtn = e.target;
            const correct = selectedBtn.dataset.correct === 'true';
            if (correct) {
                score++;
            }
            Array.from(answerButtonsContainer.children).forEach(button => {
                setStatusClass(button, button.dataset.correct === 'true');
                button.disabled = true;
            });
            if (shuffledQuestions.length > currentQuestionIndex + 1) {
                nextQuizBtn.classList.remove('hidden');
            } else {
                showResults();
            }
        }

        function setStatusClass(element, correct) {
            clearStatusClass(element);
            if (correct) {
                element.classList.add('correct');
            } else {
                element.classList.add('wrong');
            }
        }
        
        function clearStatusClass(element) {
            element.classList.remove('correct');
            element.classList.remove('wrong');
        }
        
        function showResults() {
            quizContainer.classList.add('hidden');
            quizResultsContainer.classList.remove('hidden');
            scoreText.innerText = `You scored ${score} out of ${shuffledQuestions.length}!`;
        }

        // --- Event Listeners ---
        flashcard.addEventListener('click', (e) => {
            if (e.target.closest('.audio-btn')) return;
            if(currentData.length > 0) flashcard.classList.toggle('is-flipped');
        });

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                renderCard(currentIndex);
                updateButtons();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < currentData.length - 1) {
                currentIndex++;
                renderCard(currentIndex);
                updateButtons();
            }
        });
        
        searchBar.addEventListener('keyup', filterBySearch);
        
        startQuizBtn.addEventListener('click', startQuiz);
        nextQuizBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            setNextQuestion();
        });
        restartQuizBtn.addEventListener('click', startQuiz);

        document.addEventListener('DOMContentLoaded', () => {
            setupThemeFilters();
            renderCard(currentIndex);
            updateButtons();
            setupChart();
        });

    </script>
</body>
</html>
