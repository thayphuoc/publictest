<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Reading Test: Koalas</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .highlight-yellow {
            background-color: #fef08a;
            border-bottom: 2px solid #eab308;
            cursor: pointer;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .context-menu {
            display: none;
            position: absolute;
            z-index: 1000;
            width: 180px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #374151;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .explanation-box {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Cải thiện độ tương phản cho đáp án được chọn --- */
        .option-radio:checked + label {
            border-color: #1d4ed8; /* Blue-700 */
            background-color: #dbeafe; /* Blue-100 */
            color: #1e40af; /* Blue-800 */
            font-weight: 600;
            box-shadow: 0 0 0 1px #1d4ed8;
        }

        /* Review Mode Styles */
        .review-mode .correct-option {
            background-color: #dcfce7 !important; /* Green-100 */
            border-color: #15803d !important; /* Green-700 */
            color: #14532d !important;
            font-weight: 600;
        }
        
        .review-mode .wrong-option {
            background-color: #fee2e2 !important; /* Red-100 */
            border-color: #b91c1c !important; /* Red-700 */
            color: #7f1d1d !important;
            font-weight: 600;
        }

        .paragraph-label {
            float: left;
            font-weight: bold;
            color: #2563eb;
            margin-right: 8px;
            font-size: 1.1em;
        }

        .question-block {
            transition: all 0.2s;
        }
        .question-block:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 shadow-sm z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-leaf"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">IELTS Reading Practice: Koalas</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-sm text-gray-500 hidden md:block">
                <i class="fa-regular fa-clock mr-1"></i> Thời gian: Không giới hạn
            </div>
            <div id="score-display" class="hidden bg-green-100 text-green-800 px-4 py-1 rounded-full font-bold border border-green-200 shadow-sm">
                Điểm: <span id="score-value">0/0</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden relative" id="main-container">
        
        <!-- Left Panel: Reading Text -->
        <div class="w-1/2 bg-white border-r border-gray-200 overflow-y-auto relative custom-scrollbar" id="reading-panel">
            <div class="p-8 max-w-3xl mx-auto">
                <div class="mb-4">
                    <!-- Added ID here if needed in future, but currently hardcoded -->
                    <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded uppercase tracking-wide">Nature & Wildlife</span>
                </div>
                <!-- ADDED ID="reading-title" HERE -->
                <h2 class="text-3xl font-bold text-gray-900 mb-6 leading-tight" id="reading-title">Koalas</h2>
                
                <!-- Reading Content -->
                <div class="prose prose-blue text-gray-700 leading-loose text-lg text-justify" id="reading-content">
                    <!-- Content injected via JS -->
                </div>

                <!-- Vocabulary Table -->
                <div class="mt-12 pt-8 border-t-2 border-dashed border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-spell-check text-yellow-500 mr-2"></i> Từ vựng quan trọng (B2+)
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Từ / Cụm từ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nghĩa / Ngữ cảnh</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="vocab-body">
                                <!-- Vocab injected via JS -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-sm text-gray-400 mt-2 italic">* Mẹo: Chuột phải vào văn bản để tô màu (Highlight).</p>
                </div>
                <div class="h-20"></div> <!-- Spacer -->
            </div>
        </div>

        <!-- Right Panel: Questions -->
        <div class="w-1/2 bg-gray-50 overflow-y-auto custom-scrollbar" id="questions-panel">
            <div class="p-8 max-w-3xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Câu hỏi</h2>
                    <span class="text-sm text-gray-500 bg-white px-3 py-1 rounded border border-gray-200 shadow-sm" id="question-count"></span>
                </div>

                <!-- Submission Notification Hint (Hidden by default) -->
                <div id="review-hint" class="hidden bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg mb-6 flex items-start">
                    <i class="fa-solid fa-circle-info mt-1 mr-3 text-blue-500"></i>
                    <div>
                        <span class="font-bold">Đã nộp bài!</span><br>
                        Nhấn vào từng câu hỏi bên dưới để xem đáp án đúng và giải thích chi tiết.
                    </div>
                </div>

                <div id="questions-container" class="space-y-6">
                    <!-- Questions injected via JS -->
                </div>
                
                <div class="h-20"></div> <!-- Spacer -->
            </div>
        </div>

    </div>

    <!-- Bottom Navigation Bar -->
    <footer class="bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 shrink-0">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            
            <!-- Pagination (Hidden for single page test but kept for structure) -->
            <div class="flex gap-2" id="pagination-controls" style="visibility: hidden;">
                <!-- Injected via JS -->
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 ml-auto">
                <button id="btn-submit" onclick="submitTest()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg transition shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Nộp Bài
                </button>
                <button id="btn-reset" onclick="resetTest()" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg transition flex items-center gap-2">
                    <i class="fa-solid fa-rotate-right"></i> Làm Lại
                </button>
            </div>
        </div>
    </footer>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="btn-highlight">
            <i class="fa-solid fa-highlighter text-yellow-500"></i> Tô sáng (Highlight)
        </div>
        <div class="context-menu-item" id="btn-remove-highlight">
            <i class="fa-solid fa-eraser text-red-500"></i> Xóa tô sáng
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity opacity-0 pointer-events-none">
        Thông báo
    </div>

    <script>
        // --- Dữ liệu bài đọc Koalas ---
        const koalaData = {
            id: 1,
            title: "Koalas",
            tag: "Nature & Wildlife",
            content: `
                <p class="mb-4"><span class="paragraph-label">A</span> Koalas are just too nice for their own good. And except for the occasional baby taken by birds of prey, koalas have no natural enemies. In an ideal world, the life of an arboreal couch potato would be perfectly safe and acceptable.</p>
                <p class="mb-4"><span class="paragraph-label">B</span> Just two hundred years ago, koalas flourished across Australia. Now they seem to be in decline, but exact numbers are not available as the species would not seem to be ‘under threat’. Their problem, however, has been man, more specifically, the white man. Koala and aborigines had co-existed peacefully for centuries.</p>
                <p class="mb-4"><span class="paragraph-label">C</span> Today koalas are found only in scattered pockets of southeast Australia, where they seem to be at risk on several fronts. The koala’s only food source, the eucalyptus tree, has declined. In the past 200 years, a third of Australia’s eucalyptus forests have disappeared. Koalas have been killed by parasites, chlamydia epidemics and a tumour-causing retro-virus. And every year 11000 are killed by cars, ironically most of them in wildlife sanctuaries, and thousands are killed by poachers. Some are also taken illegally as pets. The animals usually soon die, but they are easily replaced.</p>
                <p class="mb-4"><span class="paragraph-label">D</span> Bush fires pose another threat. The horrific ones that raged in New South Wales recently killed between 100 and 1000 koalas. Many that were taken into sanctuaries and shelters were found to have burnt their paws on the glowing embers. But zoologists say that the species should recover. The koalas will be aided by the eucalyptus, which grows quickly and is already burgeoning forth after the fires. So the main problem to their survival is their slow reproductive rate – they produce only one baby a year over a reproductive lifespan of about nine years.</p>
                <p class="mb-4"><span class="paragraph-label">E</span> The latest problem for the species is perhaps more insidious. With plush, grey fur, dark amber eyes and button nose, koalas are cuddliness incarnate. Australian zoos and wildlife parks have taken advantage of their uncomplaining attitudes, and charge visitors to be photographed hugging the furry bundles. But people may not realise how cruel this is, but because of the koala’s delicate disposition, constant handling can push an already precariously balanced physiology over the edge.</p>
                <p class="mb-4"><span class="paragraph-label">F</span> Koalas only eat the foliage of certain species of eucalyptus trees, between 600 and 1250 grams a day. The tough leaves are packed with cellulose, tannins, aromatic oils and precursors of toxic cyanides. To handle this cocktail, koalas have a specialised digestive system. Cellulose-digesting bacteria in the breakdown fibre, while a specially adapted gut and liver process the toxins. To digest their food properly, koalas must sit still for 21 hours every day.</p>
                <p class="mb-4"><span class="paragraph-label">G</span> Koalas are the epitome of innocence and inoffensiveness. Although they are capable of ripping open a man’s arm with their needle-sharp claws, or giving a nasty nip, they simply wouldn’t. If you upset a koala, it may blink or swallow, or hiccup. But attack? No way! Koalas are just not aggressive. They use their claws to grip the hard smooth bark of eucalyptus trees.</p>
                <p class="mb-4"><span class="paragraph-label">H</span> They are also very sensitive, and the slightest upset can prevent them from breeding, cause them to go off their food, and succumb to gut infections. Koalas are stoic creatures and put on a brave face until they are at death’s door. One day they may appear healthy, the next they could be dead. Captive koalas have to be weighed daily to check that they are feeding properly. A sudden loss of weight is usually the only warning keepers have that their charge is ill. Only two keepers plus a vet were allowed to handle London Zoo’s koalas, as these creatures are only comfortable with people they know. A request for the koala to be taken to meet the Queen was refused because of the distress this would have caused the marsupial. Sadly, London’s Zoo no longer has a koala. Two years ago the female koala died of cancer caused by a retrovirus. When they come into heat, female koalas become more active, and start losing weight, but after about sixteen days, heat ends and the weight piles back on. London’s koala did not. Surgery revealed hundreds of pea-sized tumours. Almost every zoo in Australia has koalas – the marsupial has become the Animal Ambassador of the nation, but nowhere outside Australia would handling by the public be allowed. Koala cuddling screams in the face of every rule of good care. First, some zoos allow koalas to be passed from stranger to stranger, many children who love to squeeze. Secondly, most people have no idea of how to handle the animals; they like to cling on to their handler, all in their own good time and use his or her arm as a tree. For such reasons, the Association of Fauna and Marine parks, an Australian conservation society is campaigning to ban koala cuddling. Policy on koala handling is determined by state government authorities. And the largest of the numbers in the Australian Nature Conservation Agency, with the aim of instituting national guidelines. Following a wave of publicity, some zoos and wildlife parks have stopped turning their koalas into photos.</p>
            `,
            vocab: [
                { word: "Arboreal (adj)", meaning: "Sống ở trên cây" },
                { word: "Flourish (v)", meaning: "Phát triển mạnh mẽ, hưng thịnh" },
                { word: "Parasite (n)", meaning: "Ký sinh trùng" },
                { word: "Insidious (adj)", meaning: "Ngấm ngầm, xảo quyệt (gây hại từ từ)" },
                { word: "Incarnate (adj)", meaning: "Hiện thân, bằng xương bằng thịt" },
                { word: "Precarious (adj)", meaning: "Bấp bênh, không ổn định" },
                { word: "Foliage (n)", meaning: "Tán lá, bộ lá" },
                { word: "Epitome (n)", meaning: "Hình mẫu hoàn hảo, ví dụ điển hình" },
                { word: "Stoic (adj)", meaning: "Khắc kỷ (chịu đựng đau đớn mà không than vãn)" },
                { word: "Succumb (v)", meaning: "Đầu hàng, không qua khỏi (bệnh tật)" },
                { word: "Marsupial (n)", meaning: "Thú có túi (như Kangaroo, Koala)" }
            ],
            questions: [
                {
                    id: "q1",
                    text: "1. The main reason why koala declined is that they are killed EXCEPT FOR:",
                    options: [
                        { id: "A", text: "by poachers" },
                        { id: "B", text: "by diseases they got" },
                        { id: "C", text: "giving too many birth yet survived little!" },
                        { id: "D", text: "accidents on the road" }
                    ],
                    correct: "C",
                    explanation: "<strong>Đáp án: C.</strong><br>Câu hỏi tìm lý do NGOẠI TRỪ (EXCEPT).<br>- Đoạn C liệt kê các nguyên nhân giết chết Koala: 'killed by parasites, chlamydia epidemics' (B), 'killed by cars' (D), 'killed by poachers' (A).<br>- Đoạn D đề cập đến vấn đề sinh sản: 'slow reproductive rate' (tỉ lệ sinh sản chậm), nghĩa là sinh ít chứ không phải sinh nhiều (giving too many birth). Do đó C là đáp án ngoại trừ (vì thông tin sai)."
                },
                {
                    id: "q2",
                    text: "2. What can help koalas fully digest their food?",
                    options: [
                        { id: "A", text: "toxic substance in the leaves" },
                        { id: "B", text: "organs that dissolve the fibres" },
                        { id: "C", text: "remaining inactive for a period to digest" },
                        { id: "D", text: "eating eucalyptus trees" }
                    ],
                    correct: "C",
                    explanation: "<strong>Đáp án: C.</strong><br>Đoạn F: 'To digest their food properly, koalas must sit still for 21 hours every day.' (Để tiêu hóa thức ăn đúng cách, koala phải ngồi yên 21 giờ mỗi ngày). Điều này tương ứng với 'remaining inactive'."
                },
                {
                    id: "q3",
                    text: "3. What would koalas do when facing the dangerous situation?",
                    options: [
                        { id: "A", text: "show signs of being offended" },
                        { id: "B", text: "counter attack furiously" },
                        { id: "C", text: "use sharp claws to rip the man" },
                        { id: "D", text: "use claws to grip the bark of trees." }
                    ],
                    correct: "A",
                    explanation: "<strong>Đáp án: A.</strong><br>Đoạn G: 'If you upset a koala, it may blink or swallow, or hiccup. But attack? No way!' (Nếu bạn làm koala khó chịu, nó có thể chớp mắt, nuốt hoặc nấc cụt). Đây là những dấu hiệu nhẹ nhàng (signs of being offended) chứ không tấn công."
                },
                {
                    id: "q4",
                    text: "4. In what ways Australian zoos exploit koalas?",
                    options: [
                        { id: "A", text: "encourage people to breed koalas as pets" },
                        { id: "B", text: "allow tourists to hug the koalas" },
                        { id: "C", text: "put them on the trees as a symbol" },
                        { id: "D", text: "establish a koala campaign" }
                    ],
                    correct: "B",
                    explanation: "<strong>Đáp án: B.</strong><br>Đoạn E: 'Australian zoos... charge visitors to be photographed hugging the furry bundles.' (Các sở thú thu tiền du khách để chụp ảnh ôm những chú gấu bông này)."
                },
                {
                    id: "q5",
                    text: "5. What would the government do to protect koalas from being endangered?",
                    options: [
                        { id: "A", text: "introduce koala protection guidelines" },
                        { id: "B", text: "close some of the zoos" },
                        { id: "C", text: "encourage people to resist visiting the zoos" },
                        { id: "D", text: "persuade the public to learn more knowledge" }
                    ],
                    correct: "A",
                    explanation: "<strong>Đáp án: A.</strong><br>Đoạn H (gần cuối): 'And the largest of the numbers in the Australian Nature Conservation Agency, with the aim of instituting national guidelines.' (Mục tiêu thiết lập các hướng dẫn quốc gia)."
                },
                {
                    id: "q6",
                    text: "6. New coming human settlers caused danger to koalas.",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "YES",
                    explanation: "<strong>Đáp án: YES.</strong><br>Đoạn B: 'Their problem, however, has been man, more specifically, the white man.' (Vấn đề của chúng là con người, cụ thể là người da trắng - ám chỉ người định cư mới)."
                },
                {
                    id: "q7",
                    text: "7. Koalas can still be seen in most of the places in Australia.",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "NO",
                    explanation: "<strong>Đáp án: NO.</strong><br>Đoạn C: 'Today koalas are found only in scattered pockets of southeast Australia'. (Chỉ tìm thấy ở những vùng rải rác ở đông nam Úc), trái ngược với 'most of the places'."
                },
                {
                    id: "q8",
                    text: "8. It takes decades for the eucalyptus trees to recover after the fire.",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "NO",
                    explanation: "<strong>Đáp án: NO.</strong><br>Đoạn D: 'The koalas will be aided by the eucalyptus, which grows quickly and is already burgeoning forth after the fires.' (Cây bạch đàn mọc nhanh và đã đâm chồi nảy lộc ngay sau đám cháy). Không mất 'decades'."
                },
                {
                    id: "q9",
                    text: "9. Koalas will fight each other when food becomes scarce.",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "NOT GIVEN",
                    explanation: "<strong>Đáp án: NOT GIVEN.</strong><br>Bài đọc nói Koala không hung dữ (not aggressive), nhưng không đề cập cụ thể việc chúng có đánh nhau khi thiếu thức ăn hay không."
                },
                {
                    id: "q10",
                    text: "10. It is not easy to notice that koalas are ill.",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "YES",
                    explanation: "<strong>Đáp án: YES.</strong><br>Đoạn H: 'Koalas are stoic creatures... A sudden loss of weight is usually the only warning keepers have that their charge is ill.' (Chúng rất giỏi chịu đựng... Giảm cân đột ngột thường là cảnh báo duy nhất)."
                },
                {
                    id: "q11",
                    text: "11. Koalas are easily infected with human contagious disease via cuddling",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "NOT GIVEN",
                    explanation: "<strong>Đáp án: NOT GIVEN.</strong><br>Đoạn E nói 'constant handling' (việc đụng chạm liên tục) gây hại cho tâm lý và thể chất (stress), nhưng không nói rõ là lây 'human contagious disease' (bệnh truyền nhiễm của người) qua việc ôm ấp."
                },
                {
                    id: "q12",
                    text: "12. Koalas like to hold a person’s arm when they are embraced.",
                    options: [
                        { id: "YES", text: "YES" },
                        { id: "NO", text: "NO" },
                        { id: "NOT GIVEN", text: "NOT GIVEN" }
                    ],
                    correct: "YES",
                    explanation: "<strong>Đáp án: YES.</strong><br>Đoạn H: 'they like to cling on to their handler... and use his or her arm as a tree.' (Chúng thích bám vào người huấn luyện và dùng cánh tay họ như cái cây)."
                },
                {
                    id: "q13",
                    text: "13. In your opinion this article written by",
                    options: [
                        { id: "A", text: "a journalist who writes for magazine" },
                        { id: "B", text: "a zoo keeper in London Zoo." },
                        { id: "C", text: "a tourist who is traveling back from Australia" },
                        { id: "D", text: "a government official who studies koalas to establish a law" }
                    ],
                    correct: "A",
                    explanation: "<strong>Đáp án: A.</strong><br>Bài viết có giọng văn khách quan, cung cấp thông tin tổng hợp từ nhiều nguồn (lịch sử, sinh học, vấn đề bảo tồn), sử dụng ngôn ngữ phong phú và mang tính kể chuyện ('arboreal couch potato', 'cuddliness incarnate'). Đây là phong cách điển hình của báo chí/tạp chí. Không phải B (vì nói London Zoo ở ngôi thứ 3), C (quá chi tiết về chuyên môn), D (văn phong không khô khan như luật)."
                }
            ]
        };

        const testData = [koalaData]; // Wrap in array to reuse logic

        // --- State Management ---
        let userAnswers = {}; 
        let isSubmitted = false;
        let selectedRange = null;

        // --- DOM Elements ---
        const readingTitle = document.getElementById('reading-title');
        const readingContent = document.getElementById('reading-content');
        const vocabBody = document.getElementById('vocab-body');
        const questionsContainer = document.getElementById('questions-container');
        const questionCountLabel = document.getElementById('question-count');
        const btnSubmit = document.getElementById('btn-submit');
        const btnReset = document.getElementById('btn-reset');
        const scoreDisplay = document.getElementById('score-display');
        const scoreValue = document.getElementById('score-value');
        const contextMenu = document.getElementById('context-menu');
        const notification = document.getElementById('notification');
        const reviewHint = document.getElementById('review-hint');

        // --- Initialization ---
        function init() {
            // Check if essential elements exist to avoid null errors
            if (!readingTitle || !readingContent) {
                console.error("Critical DOM elements missing.");
                return;
            }
            loadExercise(0);
            
            // Event Listeners
            document.addEventListener('click', hideContextMenu);
            readingContent.addEventListener('contextmenu', showContextMenu);
            document.getElementById('btn-highlight').addEventListener('click', highlightSelection);
            document.getElementById('btn-remove-highlight').addEventListener('click', removeHighlight);
        }

        // --- Core Functions ---

        function loadExercise(index) {
            const data = testData[index];

            // 1. Render Reading Panel
            if (readingTitle) readingTitle.innerText = data.title;
            if (readingContent) readingContent.innerHTML = data.content; 
            
            // Render Vocab
            if (vocabBody) {
                vocabBody.innerHTML = data.vocab.map(v => `
                    <tr class="hover:bg-blue-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-700">${v.word}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${v.meaning}</td>
                    </tr>
                `).join('');
            }

            // 2. Render Questions Panel
            if (questionCountLabel) questionCountLabel.innerText = `${data.questions.length} Câu hỏi`;
            if (questionsContainer) {
                questionsContainer.innerHTML = data.questions.map((q, qIndex) => `
                    <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm transition-all question-block relative" id="block-${q.id}">
                        
                        <!-- View Explanation Label (Review Mode Only) -->
                        <div class="absolute top-4 right-4 text-blue-600 text-xs font-bold hidden review-indicator">
                            <i class="fa-solid fa-eye"></i> Xem giải thích
                        </div>

                        <div class="flex items-start gap-3 mb-4">
                            <span class="bg-gray-800 text-white text-xs font-bold px-2 py-1 rounded mt-1 shrink-0">Q${qIndex + 1}</span>
                            <p class="text-gray-800 font-medium text-lg leading-snug">${q.text.substring(q.text.indexOf(' ')+1)}</p>
                        </div>
                        
                        <div class="space-y-3 pl-2">
                            ${q.options.map(opt => `
                                <div class="relative">
                                    <input type="radio" name="${q.id}" id="${q.id}_${opt.id}" value="${opt.id}" 
                                        class="option-radio hidden peer" 
                                        ${userAnswers[q.id] === opt.id ? 'checked' : ''}
                                        ${isSubmitted ? 'disabled' : ''}
                                        onchange="handleAnswer('${q.id}', '${opt.id}')">
                                    <label for="${q.id}_${opt.id}" 
                                        class="flex items-center p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all peer-checked:border-blue-700 peer-checked:bg-blue-100"
                                        id="label-${q.id}-${opt.id}">
                                        <div class="w-6 h-6 rounded-full border border-gray-300 flex items-center justify-center mr-3 peer-checked:border-blue-700 peer-checked:bg-blue-700 text-white text-xs shrink-0">
                                            ${userAnswers[q.id] === opt.id ? '<i class="fa-solid fa-check"></i>' : opt.id}
                                        </div>
                                        <span class="text-gray-700 font-medium">${opt.text}</span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Explanation Area (Hidden initially) -->
                        <div class="explanation-box mt-4 pt-4 border-t border-gray-100 bg-blue-50 p-5 rounded-md text-sm text-gray-800" id="explain-${q.id}">
                            <div class="font-bold text-blue-800 mb-2 flex items-center text-base"><i class="fa-solid fa-lightbulb text-yellow-500 mr-2"></i> Giải thích chi tiết:</div>
                            <div class="leading-relaxed">
                                ${q.explanation}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Update UI for Submitted State if applicable
            if (isSubmitted) {
                applyReviewStyles();
                if (reviewHint) reviewHint.classList.remove('hidden');
            } else {
                if (reviewHint) reviewHint.classList.add('hidden');
            }
        }

        function handleAnswer(questionId, selectedOptionId) {
            if (isSubmitted) return;
            userAnswers[questionId] = selectedOptionId;
        }

        // --- Submission & Grading ---

        function submitTest() {
            const answeredCount = Object.keys(userAnswers).length;
            const totalQuestions = koalaData.questions.length;

            let msg = "Bạn có chắc chắn muốn nộp bài không?";
            if (answeredCount === 0) {
                msg = "Bạn chưa làm câu nào cả. Bạn có chắc muốn nộp bài và xem đáp án ngay không?";
            } else if (answeredCount < totalQuestions) {
                msg = `Bạn mới làm ${answeredCount}/${totalQuestions} câu. Bạn có chắc muốn nộp không?`;
            }
            
            const confirmSubmit = confirm(msg);
            if (!confirmSubmit) return;

            try {
                isSubmitted = true;
                let correctCount = 0;

                koalaData.questions.forEach(q => {
                    if (userAnswers[q.id] === q.correct) {
                        correctCount++;
                    }
                });

                // Update Header
                if (scoreValue) scoreValue.innerText = `${correctCount}/${totalQuestions}`;
                if (scoreDisplay) {
                    scoreDisplay.classList.remove('hidden');
                    scoreDisplay.classList.add('flex', 'items-center');
                }

                // Update Buttons
                if (btnSubmit) btnSubmit.classList.add('hidden');
                if (btnReset) btnReset.classList.remove('hidden');

                // Reload current view to apply styles
                loadExercise(0);
                
                // Scroll to top
                if (questionsContainer) {
                    const panel = document.getElementById('questions-panel');
                    if (panel) panel.scrollTo({ top: 0, behavior: 'smooth' });
                }
                
                showNotification(`Đã nộp bài! Bạn đúng ${correctCount}/${totalQuestions} câu.`);
            } catch (error) {
                console.error("Submission Error:", error);
                showNotification("Có lỗi xảy ra khi nộp bài. Vui lòng thử lại.");
            }
        }

        function applyReviewStyles() {
            document.body.classList.add('review-mode');
            const currentQuestions = koalaData.questions;

            currentQuestions.forEach(q => {
                const userAnswer = userAnswers[q.id];
                const correctAnswer = q.correct;
                const explanationBox = document.getElementById(`explain-${q.id}`);
                const questionBlock = document.getElementById(`block-${q.id}`);
                const reviewIndicator = questionBlock.querySelector('.review-indicator');

                if (reviewIndicator) reviewIndicator.classList.remove('hidden');

                const inputs = document.querySelectorAll(`input[name="${q.id}"]`);
                inputs.forEach(input => input.disabled = true);

                const correctLabel = document.getElementById(`label-${q.id}-${correctAnswer}`);
                if (correctLabel) {
                    correctLabel.classList.add('correct-option');
                    if (!correctLabel.innerHTML.includes('fa-check-circle')) {
                        correctLabel.innerHTML += ` <i class="fa-solid fa-check-circle ml-auto text-green-700 text-lg"></i>`;
                    }
                }

                if (userAnswer && userAnswer !== correctAnswer) {
                    const wrongLabel = document.getElementById(`label-${q.id}-${userAnswer}`);
                    if (wrongLabel) {
                        wrongLabel.classList.add('wrong-option');
                        if (!wrongLabel.innerHTML.includes('fa-times-circle')) {
                            wrongLabel.innerHTML += ` <i class="fa-solid fa-times-circle ml-auto text-red-700 text-lg"></i>`;
                        }
                    }
                }

                questionBlock.style.cursor = "pointer";
                questionBlock.onclick = (e) => {
                    if (e.target.closest('.explanation-box')) return;
                    if (explanationBox.style.display === 'block') {
                        explanationBox.style.display = 'none';
                        questionBlock.classList.remove('ring-2', 'ring-blue-400');
                    } else {
                        explanationBox.style.display = 'block';
                        questionBlock.classList.add('ring-2', 'ring-blue-400');
                    }
                };
            });
        }

        function resetTest() {
            if(confirm("Làm lại sẽ xóa hết kết quả. Bạn có chắc không?")) {
                isSubmitted = false;
                userAnswers = {};
                document.body.classList.remove('review-mode');
                if (scoreDisplay) scoreDisplay.classList.add('hidden');
                if (btnSubmit) btnSubmit.classList.remove('hidden');
                if (btnReset) btnReset.classList.add('hidden');
                loadExercise(0); 
            }
        }

        // --- Context Menu & Highlighting ---
        function showContextMenu(e) {
            e.preventDefault();
            const selection = window.getSelection();
            if (selection.toString().trim() === '') return;
            selectedRange = selection.getRangeAt(0);
            let x = e.clientX;
            let y = e.clientY;
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
            contextMenu.style.display = 'block';
        }

        function hideContextMenu() { contextMenu.style.display = 'none'; }

        function highlightSelection() {
            if (!selectedRange) return;
            try {
                const span = document.createElement('span');
                span.className = 'highlight-yellow';
                span.title = 'Nhấn để xóa';
                span.onclick = function(e) {
                    e.stopPropagation();
                    const parent = this.parentNode;
                    while(this.firstChild) parent.insertBefore(this.firstChild, this);
                    parent.removeChild(this);
                };
                selectedRange.surroundContents(span);
                window.getSelection().removeAllRanges();
            } catch (e) {
                showNotification("Vui lòng chỉ chọn văn bản trong một đoạn.");
            }
            hideContextMenu();
        }

        function removeHighlight() {
            showNotification("Mẹo: Nhấn chuột trái vào vùng đã tô màu để xóa nó.");
            hideContextMenu();
        }

        function showNotification(msg) {
            if (!notification) return;
            notification.innerText = msg;
            notification.style.opacity = '1';
            setTimeout(() => { notification.style.opacity = '0'; }, 3000);
        }

        // Start App
        init();

    </script>
</body>
</html>